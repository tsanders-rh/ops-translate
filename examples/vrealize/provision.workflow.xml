<?xml version="1.0" encoding="UTF-8"?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd"
          root-name="item0" object-name="Workflow:name=generic" id="bd8f8e4a-8e6f-4d5c-9c4a-7b8a5e3f2d1c"
          version="1.0.0" api-version="6.0.0" allowed-operations="vef">

  <display-name><![CDATA[Provision VM with Governance]]></display-name>
  <description><![CDATA[Provisions a virtual machine with environment-based configuration and approval workflow]]></description>

  <position x="100.0" y="50.0"/>

  <input>
    <param name="vmName" type="string">
      <description><![CDATA[Name of the virtual machine]]></description>
    </param>
    <param name="environment" type="string">
      <description><![CDATA[Target environment (dev or prod)]]></description>
    </param>
    <param name="cpuCount" type="number">
      <description><![CDATA[Number of CPU cores]]></description>
    </param>
    <param name="memoryGB" type="number">
      <description><![CDATA[Memory in GB]]></description>
    </param>
    <param name="ownerEmail" type="string">
      <description><![CDATA[Email address of the VM owner]]></description>
    </param>
    <param name="costCenter" type="string">
      <description><![CDATA[Cost center for chargeback (optional)]]></description>
    </param>
  </input>

  <output>
    <param name="vmId" type="string">
      <description><![CDATA[ID of the created VM]]></description>
    </param>
    <param name="provisioningStatus" type="string">
      <description><![CDATA[Status of the provisioning operation]]></description>
    </param>
  </output>

  <attrib name="networkName" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Selected network based on environment]]></description>
  </attrib>

  <attrib name="storageName" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Selected storage based on environment]]></description>
  </attrib>

  <attrib name="approvalRequired" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
    <description><![CDATA[Whether approval is required]]></description>
  </attrib>

  <workflow-item name="item0" type="end" end-mode="0">
    <position x="700.0" y="200.0"/>
  </workflow-item>

  <workflow-item name="item1" out-name="item2" type="task">
    <display-name><![CDATA[Validate Inputs]]></display-name>
    <script encoded="false"><![CDATA[
// Validate VM name
if (!vmName || vmName.length == 0) {
    throw "VM name is required";
}

// Validate environment
if (environment != "dev" && environment != "prod") {
    throw "Environment must be 'dev' or 'prod'";
}

// Validate CPU count
if (cpuCount < 1 || cpuCount > 32) {
    throw "CPU count must be between 1 and 32";
}

// Validate memory
if (memoryGB < 1 || memoryGB > 256) {
    throw "Memory must be between 1 and 256 GB";
}

// Validate owner email format
if (!ownerEmail || ownerEmail.indexOf("@") == -1) {
    throw "Valid owner email is required";
}

System.log("Input validation successful");
    ]]></script>
    <in-binding>
      <bind name="vmName" type="string" export-name="vmName"/>
      <bind name="environment" type="string" export-name="environment"/>
      <bind name="cpuCount" type="number" export-name="cpuCount"/>
      <bind name="memoryGB" type="number" export-name="memoryGB"/>
      <bind name="ownerEmail" type="string" export-name="ownerEmail"/>
    </in-binding>
    <position x="200.0" y="100.0"/>
  </workflow-item>

  <workflow-item name="item2" out-name="item3" type="task">
    <display-name><![CDATA[Determine Profiles]]></display-name>
    <script encoded="false"><![CDATA[
// Set network based on environment
if (environment == "prod") {
    networkName = "prod-network";
    storageName = "storage-gold";
} else {
    networkName = "dev-network";
    storageName = "storage-standard";
}

System.log("Selected network: " + networkName);
System.log("Selected storage: " + storageName);
    ]]></script>
    <in-binding>
      <bind name="environment" type="string" export-name="environment"/>
    </in-binding>
    <out-binding>
      <bind name="networkName" type="string" export-name="networkName"/>
      <bind name="storageName" type="string" export-name="storageName"/>
    </out-binding>
    <position x="300.0" y="100.0"/>
  </workflow-item>

  <workflow-item name="item3" out-name="item4" type="decision" alt-out-name="item5">
    <display-name><![CDATA[Check Approval Required]]></display-name>
    <script encoded="false"><![CDATA[
// Approval required for production deployments
return environment == "prod";
    ]]></script>
    <in-binding>
      <bind name="environment" type="string" export-name="environment"/>
    </in-binding>
    <position x="400.0" y="100.0"/>
  </workflow-item>

  <workflow-item name="item4" out-name="item5" type="task">
    <display-name><![CDATA[Request Approval]]></display-name>
    <script encoded="false"><![CDATA[
System.log("APPROVAL REQUIRED");
System.log("VM Name: " + vmName);
System.log("Environment: " + environment);
System.log("CPU: " + cpuCount);
System.log("Memory: " + memoryGB + " GB");
System.log("Owner: " + ownerEmail);

// In a real workflow, this would trigger an approval task
// For this example, we just log the requirement
approvalRequired = true;
System.warn("Production deployment requires manual approval before proceeding");
    ]]></script>
    <in-binding>
      <bind name="vmName" type="string" export-name="vmName"/>
      <bind name="environment" type="string" export-name="environment"/>
      <bind name="cpuCount" type="number" export-name="cpuCount"/>
      <bind name="memoryGB" type="number" export-name="memoryGB"/>
      <bind name="ownerEmail" type="string" export-name="ownerEmail"/>
    </in-binding>
    <out-binding>
      <bind name="approvalRequired" type="boolean" export-name="approvalRequired"/>
    </out-binding>
    <position x="500.0" y="80.0"/>
  </workflow-item>

  <workflow-item name="item5" out-name="item6" type="task">
    <display-name><![CDATA[Provision VM]]></display-name>
    <script encoded="false"><![CDATA[
System.log("Provisioning VM with configuration:");
System.log("  Name: " + vmName);
System.log("  CPU: " + cpuCount);
System.log("  Memory: " + memoryGB + " GB");
System.log("  Network: " + networkName);
System.log("  Storage: " + storageName);

// Simulate VM creation
// In a real workflow, this would call vCenter API
vmId = "vm-" + System.nextUUID();
provisioningStatus = "SUCCESS";

System.log("VM provisioned successfully with ID: " + vmId);
    ]]></script>
    <in-binding>
      <bind name="vmName" type="string" export-name="vmName"/>
      <bind name="cpuCount" type="number" export-name="cpuCount"/>
      <bind name="memoryGB" type="number" export-name="memoryGB"/>
      <bind name="networkName" type="string" export-name="networkName"/>
      <bind name="storageName" type="string" export-name="storageName"/>
    </in-binding>
    <out-binding>
      <bind name="vmId" type="string" export-name="vmId"/>
      <bind name="provisioningStatus" type="string" export-name="provisioningStatus"/>
    </out-binding>
    <position x="600.0" y="150.0"/>
  </workflow-item>

  <workflow-item name="item6" out-name="item0" type="task">
    <display-name><![CDATA[Apply Metadata Tags]]></display-name>
    <script encoded="false"><![CDATA[
// Apply tags for governance and tracking
var tags = {
    "env": environment,
    "owner": ownerEmail,
    "managed-by": "vrealize-orchestrator",
    "provisioned-date": new Date().toISOString().split('T')[0]
};

if (costCenter && costCenter.length > 0) {
    tags["costCenter"] = costCenter;
}

System.log("Applying metadata tags:");
for (var key in tags) {
    System.log("  " + key + " = " + tags[key]);
    // In real workflow: apply tag to VM
}

System.log("Day 2 operations supported: start, stop, reconfigure");
    ]]></script>
    <in-binding>
      <bind name="vmId" type="string" export-name="vmId"/>
      <bind name="environment" type="string" export-name="environment"/>
      <bind name="ownerEmail" type="string" export-name="ownerEmail"/>
      <bind name="costCenter" type="string" export-name="costCenter"/>
    </in-binding>
    <position x="650.0" y="200.0"/>
  </workflow-item>

  <presentation>
    <p-step>
      <title><![CDATA[VM Configuration]]></title>
      <p-param name="vmName">
        <desc><![CDATA[Virtual Machine Name]]></desc>
        <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
      </p-param>
      <p-param name="environment">
        <desc><![CDATA[Environment]]></desc>
        <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
        <p-qual kind="static" name="genericEnumeration" type="Array/string"><![CDATA[#{#string#dev#;#string#prod#}#]]></p-qual>
      </p-param>
      <p-param name="cpuCount">
        <desc><![CDATA[CPU Cores]]></desc>
        <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
        <p-qual kind="static" name="minNumberValue" type="Number"><![CDATA[1.0]]></p-qual>
        <p-qual kind="static" name="maxNumberValue" type="Number"><![CDATA[32.0]]></p-qual>
      </p-param>
      <p-param name="memoryGB">
        <desc><![CDATA[Memory (GB)]]></desc>
        <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
        <p-qual kind="static" name="minNumberValue" type="Number"><![CDATA[1.0]]></p-qual>
        <p-qual kind="static" name="maxNumberValue" type="Number"><![CDATA[256.0]]></p-qual>
      </p-param>
    </p-step>
    <p-step>
      <title><![CDATA[Ownership and Tracking]]></title>
      <p-param name="ownerEmail">
        <desc><![CDATA[Owner Email Address]]></desc>
        <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
      </p-param>
      <p-param name="costCenter">
        <desc><![CDATA[Cost Center (Optional)]]></desc>
        <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[false]]></p-qual>
      </p-param>
    </p-step>
  </presentation>
</workflow>
