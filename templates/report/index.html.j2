<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Report - {{ workspace.name }}</title>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <!-- Header -->
    <header class="report-header">
        <div class="container">
            <div class="header-content">
                <h1>ops-translate</h1>
                <div class="header-meta">
                    <span class="workspace-name">{{ workspace.name }}</span>
                    <span class="separator">|</span>
                    <span class="profile-name">Profile: {{ profile.name }}</span>
                    <span class="separator">|</span>
                    <span class="timestamp">{{ workspace.timestamp[:19] }}</span>
                    <span class="separator">|</span>
                    <a href="docs/PATTERNS.html" class="header-docs-link">üìö Architecture Patterns</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-navigation" role="tablist">
        <div class="container">
            <div class="tab-buttons">
                <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-executive" data-tab="executive">
                    Executive
                </button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-architecture" data-tab="architecture">
                    Architecture & Gaps
                    {% if gaps and gaps.components %}
                    {% set blocked_count = gaps.components | selectattr('level', 'equalto', 'BLOCKED') | list | length %}
                    {% if blocked_count > 0 %}
                    <span class="tab-badge">{{ blocked_count }}</span>
                    {% endif %}
                    {% endif %}
                </button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-implementation" data-tab="implementation">
                    Implementation
                </button>
            </div>
        </div>
    </nav>

    <!-- Tab Panels -->
    <div class="tab-panels">
        <!-- Executive Tab -->
        <div id="tab-executive" class="tab-panel active" role="tabpanel" aria-labelledby="tab-executive">

    <!-- Executive Summary -->
    {% if executive_summary %}
    <section class="executive-summary-section">
        <div class="container">
            <div class="executive-summary">
                <div class="executive-icon">üìã</div>
                <p class="executive-text">{{ executive_summary }}</p>
            </div>

            <!-- Export Actions -->
            <div class="export-actions">
                <button id="export-pdf" class="export-btn export-pdf">
                    <span class="export-icon">üìÑ</span>
                    <span>Export as PDF</span>
                </button>
                <button id="export-csv" class="export-btn export-csv">
                    <span class="export-icon">üìä</span>
                    <span>Export Migration Tasks (CSV)</span>
                </button>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Executive Dashboard -->
    {% if effort_metrics %}
    <section class="executive-dashboard-section">
        <div class="container">
            <h2 class="section-title">üìä Migration Effort Dashboard</h2>
            <p class="section-subtitle">Workflow-level effort estimation for sprint planning. See component-level analysis below for technical implementation details.</p>

            <!-- Estate Overview -->
            <div class="estate-summary">
                <div class="stat-card">
                    <div class="stat-value">{{ effort_metrics.estate_summary.total_workflows }}</div>
                    <div class="stat-label">Total Workflows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">~{{ "{:,}".format(effort_metrics.estate_summary.total_lines_of_code) }}</div>
                    <div class="stat-label">Lines of Code</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ effort_metrics.estate_summary.external_integrations }}</div>
                    <div class="stat-label">External Integrations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ effort_metrics.estate_summary.approval_gates }}</div>
                    <div class="stat-label">Approval Gates</div>
                </div>
            </div>

            <!-- Effort Buckets -->
            <div class="effort-buckets-container">
                <h3 class="subsection-title">Migration Complexity Breakdown</h3>
                <div class="effort-buckets">
                    <div class="bucket bucket-ready">
                        <div class="bucket-icon">üü¢</div>
                        <div class="bucket-count">{{ effort_metrics.effort_buckets.ready_now }}</div>
                        <div class="bucket-label">Ready Now</div>
                        <div class="bucket-detail">No decisions required</div>
                    </div>
                    <div class="bucket bucket-moderate">
                        <div class="bucket-icon">üü°</div>
                        <div class="bucket-count">{{ effort_metrics.effort_buckets.moderate }}</div>
                        <div class="bucket-label">Configuration Needed</div>
                        <div class="bucket-detail">1-2 sprints</div>
                    </div>
                    <div class="bucket bucket-complex">
                        <div class="bucket-icon">üî¥</div>
                        <div class="bucket-count">{{ effort_metrics.effort_buckets.complex }}</div>
                        <div class="bucket-label">Adapter Development</div>
                        <div class="bucket-detail">2-3 sprints</div>
                    </div>
                </div>
            </div>

            <!-- Cost Drivers -->
            {% if effort_metrics.cost_drivers %}
            <div class="cost-drivers-container">
                <h3 class="subsection-title">Primary Cost Drivers</h3>
                <div class="cost-drivers">
                    {% for driver in effort_metrics.cost_drivers[:5] %}
                    <div class="driver-item">
                        <div class="driver-bar" style="width: {{ driver.percentage }}%"></div>
                        <div class="driver-label">{{ driver.label }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Sprint Planning Recommendations -->
            <div class="sprint-plan-container">
                <h3 class="subsection-title">Recommended Migration Phases</h3>
                <div class="sprint-plan">
                    {% if effort_metrics.effort_buckets.ready_now > 0 %}
                    <div class="sprint-phase">
                        <div class="phase-header">
                            <span class="phase-label">Phase 1</span>
                            <span class="phase-duration">Sprint 1</span>
                        </div>
                        <div class="phase-content">
                            Deploy {{ effort_metrics.effort_buckets.ready_now }} ready workflows immediately
                            {% if effort_metrics.effort_buckets.moderate > 0 %}+ configure {{ effort_metrics.effort_buckets.moderate }} workflows requiring profile decisions{% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if effort_metrics.effort_buckets.moderate > 0 and effort_metrics.effort_buckets.ready_now == 0 %}
                    <div class="sprint-phase">
                        <div class="phase-header">
                            <span class="phase-label">Phase 1</span>
                            <span class="phase-duration">Sprint 1-2</span>
                        </div>
                        <div class="phase-content">
                            Configure {{ effort_metrics.effort_buckets.moderate }} workflows requiring profile decisions
                        </div>
                    </div>
                    {% endif %}
                    {% if effort_metrics.effort_buckets.complex > 0 %}
                    <div class="sprint-phase">
                        <div class="phase-header">
                            <span class="phase-label">{% if effort_metrics.effort_buckets.ready_now > 0 or effort_metrics.effort_buckets.moderate > 0 %}Phase 2{% else %}Phase 1{% endif %}</span>
                            <span class="phase-duration">Sprint {% if effort_metrics.effort_buckets.ready_now > 0 or effort_metrics.effort_buckets.moderate > 0 %}2-4{% else %}1-3{% endif %}</span>
                        </div>
                        <div class="phase-content">
                            Build adapters for {{ effort_metrics.effort_buckets.complex }} complex workflows
                            {% if effort_metrics.integration_heatmap|length > 0 %}
                            (focus on {{ effort_metrics.integration_heatmap|length }} workflows with external integrations)
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <p class="sprint-note">
                    <strong>Total Estimated Effort:</strong>
                    {% set total_sprints = 1 if effort_metrics.effort_buckets.ready_now > 0 else 0 %}
                    {% set total_sprints = total_sprints + (2 if effort_metrics.effort_buckets.moderate > 0 else 0) %}
                    {% set total_sprints = total_sprints + (3 if effort_metrics.effort_buckets.complex > 0 else 0) %}
                    {{ total_sprints }} sprint{% if total_sprints != 1 %}s{% endif %}
                    ({{ effort_metrics.estate_summary.total_workflows }} workflows, not a rewrite)
                </p>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Real-World Migration Story -->
    <section class="migration-story-section">
        <div class="container">
            <div class="migration-story">
                <div class="story-header">
                    <span class="story-label">PROVEN APPROACH</span>
                    <h2>Automating the Safe 70‚Äì80%, Guiding You Through the Rest</h2>
                </div>
                <div class="story-content">
                    <p class="story-intro">
                        {% if workspace.name == "sample-workspace" %}
                        This analysis represents a typical enterprise automation estate‚Äîyears of vRealize workflows, PowerCLI scripts for provisioning, NSX security policies, and ServiceNow integrations. The kind of automation debt that accumulates when teams deliver value quarter after quarter.
                        {% else %}
                        We analyzed <strong>{{ workspace.name }}</strong> ‚Äî {{ summary.total_components if summary.total_components is defined else ((summary.counts.SUPPORTED or 0) + (summary.counts.PARTIAL or 0) + (summary.counts.BLOCKED or 0) + (summary.counts.MANUAL or 0)) }} components across your automation estate, including complex workflows with NSX integration, approval gates, and custom orchestration.
                        {% endif %}
                    </p>
                    <div class="story-results">
                        <div class="story-stat">
                            <div class="stat-number">{{ summary.counts.SUPPORTED or 0 }}</div>
                            <div class="stat-label">Components<br>Auto-Translated</div>
                        </div>
                        <div class="story-stat">
                            <div class="stat-number">{{ summary.counts.PARTIAL or 0 }}</div>
                            <div class="stat-label">Require<br>Light Review</div>
                        </div>
                        <div class="story-stat stat-highlight">
                            <div class="stat-number">{{ (summary.counts.BLOCKED or 0) + (summary.counts.MANUAL or 0) }}</div>
                            <div class="stat-label">Expert Patterns<br>Available</div>
                        </div>
                    </div>
                    <p class="story-conclusion">
                        <strong>ops-translate</strong> provides automation for standard patterns and documented guidance for complex scenarios.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Architectural Decisions Required -->
    {% if gaps and gaps.components %}
    {% set blocked_components = gaps.components | selectattr('level', 'equalto', 'BLOCKED') | list %}
    {% set partial_components = gaps.components | selectattr('level', 'equalto', 'PARTIAL') | list %}
    {% if blocked_components or partial_components %}
    <section class="decisions-required-section">
        <div class="container">
            <h2 class="section-title">üéØ Architectural Decisions Required</h2>
            <p class="section-subtitle">The following enterprise decisions need clarification before auto-generation:</p>
            <div class="decisions-list">
                {% set decision_areas = {} %}
                {% for component in blocked_components + partial_components %}
                    {% if 'nsx' in component.component_type.lower() or 'security' in component.component_type.lower() or 'firewall' in component.component_type.lower() %}
                        {% if 'Security & Networking' not in decision_areas %}
                            {% set _ = decision_areas.update({'Security & Networking': []}) %}
                        {% endif %}
                        {% set _ = decision_areas['Security & Networking'].append(component) %}
                    {% elif 'approval' in component.component_type.lower() or 'governance' in component.component_type.lower() %}
                        {% if 'Governance & Approvals' not in decision_areas %}
                            {% set _ = decision_areas.update({'Governance & Approvals': []}) %}
                        {% endif %}
                        {% set _ = decision_areas['Governance & Approvals'].append(component) %}
                    {% elif 'network' in component.component_type.lower() or 'nic' in component.component_type.lower() %}
                        {% if 'Multi-NIC Networking' not in decision_areas %}
                            {% set _ = decision_areas.update({'Multi-NIC Networking': []}) %}
                        {% endif %}
                        {% set _ = decision_areas['Multi-NIC Networking'].append(component) %}
                    {% endif %}
                {% endfor %}
                {% for area, components in decision_areas.items() %}
                <div class="decision-area">
                    <h3>{{ area }}</h3>
                    <p class="decision-count">{{ components | length }} component(s) require decisions</p>
                    <ul class="decision-questions">
                        {% if area == 'Security & Networking' %}
                        <li>What label keys should represent NSX security group membership?</li>
                        <li>What is the default network policy stance (allow vs. deny-by-default)?</li>
                        <li>Which segmentation model: namespace-per-app or shared namespace?</li>
                        {% elif area == 'Governance & Approvals' %}
                        <li>What is the approval system of record (AAP workflow vs. ServiceNow)?</li>
                        <li>Who are the approvers and how are they identified?</li>
                        <li>What are timeout and escalation policies?</li>
                        {% elif area == 'Multi-NIC Networking' %}
                        <li>Retain multi-NIC or collapse to single network?</li>
                        <li>What is the NetworkAttachmentDefinition naming convention?</li>
                        <li>How should network attachments be selected (env-based, tier-based)?</li>
                        {% endif %}
                    </ul>
                    <p class="decision-action"><a href="#tab-architecture">‚Üí Review detailed gaps in Architecture tab</a></p>
                </div>
                {% endfor %}
                {% if decision_areas | length == 0 %}
                <p class="no-decisions">No critical architectural decisions required‚Äîworkflows are ready for configuration.</p>
                {% endif %}
            </div>
        </div>
    </section>
    {% endif %}
    {% endif %}

    <!-- Executive Conclusion -->
    <section class="executive-conclusion-section">
        <div class="container">
            <div class="conclusion-box">
                <h3>üéØ Executive Summary</h3>
                <p class="conclusion-text">
                    {% set total_comps = summary.total_components if summary.total_components is defined else ((summary.counts.SUPPORTED or 0) + (summary.counts.PARTIAL or 0) + (summary.counts.BLOCKED or 0) + (summary.counts.MANUAL or 0)) %}
                    <strong>This migration is achievable.</strong> With {{ summary.counts.SUPPORTED or 0 }} components auto-translatable and
                    {{ summary.counts.PARTIAL or 0 }} requiring configuration, your automation estate is
                    {% if total_comps > 0 %}
                    <strong>{{ ((((summary.counts.SUPPORTED or 0) + (summary.counts.PARTIAL or 0)) / total_comps) * 100) | int }}% ready</strong>
                    {% else %}
                    <strong>ready</strong>
                    {% endif %}
                    for OpenShift Virtualization.
                </p>
                <p class="conclusion-text">
                    {% if blocked_components %}
                    The {{ blocked_components | length }} BLOCKED component(s) have documented architecture patterns
                    and can be addressed through proven design decisions‚Äînot custom development.
                    {% else %}
                    No blocked components detected‚Äîclear path to implementation.
                    {% endif %}
                </p>
                <p class="conclusion-cta">
                    <strong>Next Step:</strong> Review the <a href="#tab-architecture">Architecture & Gaps tab</a> to understand required design decisions,
                    then proceed to the <a href="#tab-implementation">Implementation tab</a> for generated artifacts and deployment steps.
                </p>
            </div>
        </div>
    </section>

        </div>
        <!-- End Executive Tab -->

        <!-- Architecture & Gaps Tab -->
        <div id="tab-architecture" class="tab-panel" role="tabpanel" aria-labelledby="tab-architecture">

    <!-- At a Glance Summary Cards -->
    <section class="summary-section">
        <div class="container">
            <h2>Component-Level Translation Status</h2>
            <p class="section-subtitle">Detailed component analysis showing {{ summary.total_components if summary.total_components is defined else ((summary.counts.SUPPORTED or 0) + (summary.counts.PARTIAL or 0) + (summary.counts.BLOCKED or 0) + (summary.counts.MANUAL or 0)) }} individual components detected across your workflows.</p>
            <div class="summary-cards">
                <div class="card card-supported" data-filter="SUPPORTED" title="Components that can be fully automatically translated to OpenShift-native equivalents">
                    <div class="card-icon">‚úÖ</div>
                    <div class="card-content">
                        <div class="card-number">{{ summary.counts.SUPPORTED }}</div>
                        <div class="card-label">Supported</div>
                    </div>
                </div>
                <div class="card card-partial" data-filter="PARTIAL" title="Core intent detected, but target platform mapping requires manual decisions">
                    <div class="card-icon">‚ö†Ô∏è</div>
                    <div class="card-content">
                        <div class="card-number">{{ summary.counts.PARTIAL }}</div>
                        <div class="card-label">Partial Translation</div>
                    </div>
                </div>
                <div class="card card-blocked" data-filter="BLOCKED" title="Components requiring expert guidance">
                    <div class="card-icon">üéØ</div>
                    <div class="card-content">
                        <div class="card-number">{{ summary.counts.BLOCKED }}</div>
                        <div class="card-label">Expert-Guided</div>
                    </div>
                </div>
                <div class="card card-manual" data-filter="MANUAL" title="Components with complex custom logic requiring specialist review and implementation">
                    <div class="card-icon">üîß</div>
                    <div class="card-content">
                        <div class="card-number">{{ summary.counts.MANUAL }}</div>
                        <div class="card-label">Custom</div>
                    </div>
                </div>
            </div>

            {% if summary.overall_assessment %}
            <div class="overall-assessment">
                <strong>Overall Assessment:</strong>
                {% if summary.overall_assessment == "FULLY_TRANSLATABLE" %}
                <span class="badge badge-success">Fully Translatable</span>
                {% elif summary.overall_assessment == "HAS_BLOCKING_ISSUES" %}
                <span class="badge badge-warning">Expert Patterns Available</span>
                {% elif summary.overall_assessment == "MOSTLY_MANUAL" %}
                <span class="badge badge-error">Mostly Manual</span>
                {% else %}
                <span class="badge badge-info">{{ summary.overall_assessment.replace('_', ' ').title() }}</span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Migration Paths Quick Reference -->
            {% if gaps and gaps.components %}
            <div class="migration-paths-quick">
                <h4>Migration Paths Used in This Report</h4>
                <div class="paths-grid">
                    <div class="path-item">
                        <span class="badge badge-path-a">PATH A</span>
                        <span class="path-desc">Native OpenShift replacement</span>
                    </div>
                    <div class="path-item">
                        <span class="badge badge-path-b">PATH B</span>
                        <span class="path-desc">Hybrid approach (keep existing)</span>
                    </div>
                    <div class="path-item">
                        <span class="badge badge-path-c">PATH C</span>
                        <span class="path-desc">Custom specialist implementation</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Expert Patterns Callout -->
            {% if summary.has_blocking_issues and gaps and gaps.components %}
            <div class="next-steps-callout">
                <h3>üéØ Expert-Guided Migration</h3>
                {% for component in gaps.components %}
                    {% if component.level == "BLOCKED" %}
                    <div class="blocking-item">
                        <p class="blocking-component"><strong>{{ component.name }}</strong> is solved with proven migration patterns.</p>
                        <p class="blocking-guidance">
                            {% if component.recommendations and component.recommendations|length > 0 %}
                            {{ component.recommendations[0] }}
                            {% else %}
                            We provide documented patterns and expert guidance for this component.
                            {% endif %}
                        </p>
                        {% if component.pattern_link %}
                        <p class="pattern-link">
                            <a href="docs/PATTERNS.html#{{ component.pattern_link.anchor }}" class="btn-pattern-link">
                                üìñ {{ component.pattern_link.description }}
                            </a>
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
                <p class="callout-footer">These components use proven patterns from successful customer migrations‚Äînot guesswork.</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Target Architecture Snapshot -->
    <section class="target-architecture-section">
        <div class="container">
            <h2>Target Architecture Snapshot</h2>
            <p class="architecture-intro">Your workflows will migrate to a modern, cloud-native architecture on OpenShift. Here's where each component lands:</p>

            <div class="architecture-grid">
                <!-- OpenShift Virtualization -->
                <div class="architecture-card arch-virt">
                    <div class="arch-icon">üöÄ</div>
                    <h3>OpenShift Virtualization</h3>
                    <p class="arch-description">VM workloads run on OpenShift using KubeVirt</p>
                    <ul class="arch-components">
                        <li>VM Provisioning ‚Üí <code>VirtualMachine</code> CRDs</li>
                        <li>Compute/Memory ‚Üí Kubernetes resource requests</li>
                        <li>Lifecycle Operations ‚Üí <code>virtctl</code> commands</li>
                        <li>Metadata ‚Üí Labels & Annotations</li>
                    </ul>
                    <div class="arch-badge badge-success">{{ summary.counts.SUPPORTED or 0 }} components auto-translate</div>
                </div>

                <!-- Cloud-Native Networking -->
                <div class="architecture-card arch-network">
                    <div class="arch-icon">üåê</div>
                    <h3>Cloud-Native Networking</h3>
                    <p class="arch-description">NSX features map to Kubernetes primitives</p>
                    <ul class="arch-components">
                        <li>NSX Firewall ‚Üí NetworkPolicy</li>
                        <li>Security Groups ‚Üí Pod Label Selectors</li>
                        <li>Load Balancer ‚Üí Service (type: LoadBalancer)</li>
                        <li>Multi-Network ‚Üí Multus CNI</li>
                    </ul>
                    <div class="arch-badge badge-partial">{{ summary.counts.PARTIAL or 0 }} components need configuration</div>
                </div>

                <!-- Expert-Guided Patterns -->
                <div class="architecture-card arch-expert">
                    <div class="arch-icon">üéØ</div>
                    <h3>Expert-Guided Patterns</h3>
                    <p class="arch-description">Documented patterns for complex scenarios</p>
                    <ul class="arch-components">
                        <li>Approval Workflows ‚Üí Ansible Automation Platform</li>
                        <li>Custom Orchestration ‚Üí Ansible Playbooks</li>
                        <li>Complex Logic ‚Üí Refactored Automation</li>
                        <li>vRO Plugins ‚Üí OpenShift-native integrations</li>
                    </ul>
                    <div class="arch-badge badge-warning">{{ (summary.counts.BLOCKED or 0) + (summary.counts.MANUAL or 0) }} components use proven patterns</div>
                </div>
            </div>

            <!-- AAP Integration Note -->
            <div class="aap-integration-note">
                <p><strong>üîß Supported Automation Stack:</strong> Expert-guided patterns are delivered as Ansible roles and workflows, aligning with Red Hat's supported automation stack (Ansible Automation Platform).</p>
            </div>

            <!-- Migration Journey -->
            <div class="migration-journey">
                <h3>Migration Journey: Virt-First Approach</h3>
                <div class="journey-phases">
                    <div class="journey-phase">
                        <div class="phase-number">1</div>
                        <div class="phase-content">
                            <h4>VMware ‚Üí OpenShift Virtualization</h4>
                            <p>Migrate VMs to OpenShift with minimal risk. VMs run in KubeVirt with familiar operations.</p>
                            <span class="phase-badge">Risk Reduction</span>
                        </div>
                    </div>
                    <div class="journey-arrow">‚Üí</div>
                    <div class="journey-phase">
                        <div class="phase-number">2</div>
                        <div class="phase-content">
                            <h4>Selective Container-Native Refactor</h4>
                            <p>Optionally refactor workloads to containers when business value justifies it.</p>
                            <span class="phase-badge">Value-Driven</span>
                        </div>
                    </div>
                </div>
                <p class="journey-note"><strong>Key Point:</strong> This is not "rebuilding VMware" ‚Äî it's a pragmatic path that reduces operational cost immediately while enabling future modernization.</p>
            </div>
        </div>
    </section>

    <!-- ================================================================ -->
    <!-- LAYER 2: ARCHITECTURE IMPACT SUMMARY                             -->
    <!-- High-level design decisions, consolidated gaps, expert guidance  -->
    <!-- ================================================================ -->

    <!-- Expert Recommendations -->
    {% if recommendations and recommendations.recommendations %}
    <section class="recommendations-section layer-2">
        <div class="container">
            <h2>Expert-Guided Implementation Recommendations</h2>

            <div class="recommendations-intro">
                <p><strong>Actionable guidance for components requiring manual work.</strong> These expert recommendations provide step-by-step implementation guidance for workflow components that cannot be safely auto-migrated.</p>
                <p class="recommendations-note">‚ö†Ô∏è <strong>Important:</strong> These are recommendations, not drop-in replacements. Each recommendation requires review, testing, and validation before production use.</p>
            </div>

            <!-- Group recommendations by owner team -->
            {% set rec_by_owner = {} %}
            {% for rec in recommendations.recommendations %}
                {% set owner = rec.owner %}
                {% if owner not in rec_by_owner %}
                    {% set _ = rec_by_owner.update({owner: []}) %}
                {% endif %}
                {% set _ = rec_by_owner[owner].append(rec) %}
            {% endfor %}

            <!-- Team ownership tabs/filter -->
            <div class="recommendation-filters">
                <span class="filter-label">Filter by team:</span>
                <button class="rec-filter-btn active" data-team="all">All Teams ({{ recommendations.recommendations | length }})</button>
                {% for owner, recs in rec_by_owner.items() | sort %}
                <button class="rec-filter-btn" data-team="{{ owner }}">{{ owner }} ({{ recs | length }})</button>
                {% endfor %}
            </div>

            <!-- Recommendations list -->
            <div class="recommendations-list">
                {% for rec in recommendations.recommendations %}
                <div class="recommendation-card" data-team="{{ rec.owner }}">
                    <div class="recommendation-header">
                        <h3>{{ rec.component_name }}</h3>
                        <div class="recommendation-badges">
                            <span class="badge badge-owner">{{ rec.owner }}</span>
                            <span class="badge badge-component-type">{{ rec.component_type }}</span>
                        </div>
                    </div>

                    <div class="recommendation-body">
                        <!-- Why not auto-translatable -->
                        <div class="recommendation-section">
                            <h4>Why Not Auto-Translatable</h4>
                            <p>{{ rec.reason_not_auto_translatable }}</p>
                        </div>

                        <!-- Recommended approach -->
                        <div class="recommendation-section">
                            <h4>Recommended Ansible Approach</h4>
                            <p>{{ rec.ansible_approach }}</p>
                        </div>

                        <!-- OpenShift primitives -->
                        {% if rec.openshift_primitives %}
                        <div class="recommendation-section">
                            <h4>OpenShift/Kubernetes Primitives</h4>
                            <ul class="primitives-list">
                                {% for primitive in rec.openshift_primitives %}
                                <li><code>{{ primitive }}</code></li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Implementation steps (collapsible) -->
                        {% if rec.implementation_steps %}
                        <details class="recommendation-details">
                            <summary><h4>Implementation Steps</h4></summary>
                            <ol class="implementation-steps">
                                {% for step in rec.implementation_steps %}
                                <li>{{ step }}</li>
                                {% endfor %}
                            </ol>
                        </details>
                        {% endif %}

                        <!-- Required inputs (collapsible) -->
                        {% if rec.required_inputs %}
                        <details class="recommendation-details">
                            <summary><h4>Required Inputs</h4></summary>
                            <dl class="required-inputs">
                                {% for var_name, description in rec.required_inputs.items() %}
                                <dt><code>{{ var_name }}</code></dt>
                                <dd>{{ description }}</dd>
                                {% endfor %}
                            </dl>
                        </details>
                        {% endif %}

                        <!-- Testing guidance (collapsible) -->
                        {% if rec.testing_guidance %}
                        <details class="recommendation-details">
                            <summary><h4>Testing & Validation</h4></summary>
                            <p>{{ rec.testing_guidance }}</p>
                        </details>
                        {% endif %}

                        <!-- References -->
                        {% if rec.references %}
                        <div class="recommendation-section">
                            <h4>References</h4>
                            <ul class="references-list">
                                {% for reference in rec.references %}
                                <li><a href="{{ reference }}" target="_blank" rel="noopener noreferrer">{{ reference }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Role stub info -->
                        {% if rec.ansible_role_stub %}
                        <div class="recommendation-footer">
                            <span class="role-stub-info">üìÅ Role stub will be generated at: <code>output/ansible/roles/{{ rec.ansible_role_stub }}/</code></span>
                            <p class="role-stub-note">Run <code>ops-translate generate --format ansible --profile &lt;profile&gt;</code> to create the role stub with implementation guidance.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Consolidated Supported Patterns -->
    {% if consolidated_supported and consolidated_supported|length > 0 %}
    <section class="supported-patterns-section layer-2">
        <div class="container">
            <h2>Standard Supported Patterns</h2>

            <div class="supported-patterns-intro">
                <p>The following patterns are fully supported with automatic translation to OpenShift-native equivalents. These are omitted from detailed findings below for brevity.</p>
            </div>

            <div class="supported-patterns-list">
                {% for pattern in consolidated_supported %}
                <div class="supported-pattern-card">
                    <div class="pattern-header">
                        <span class="pattern-icon">‚úÖ</span>
                        <h3>{{ pattern.display_name }}</h3>
                        <span class="pattern-count">{{ pattern.count }} instance{{ 's' if pattern.count > 1 else '' }}</span>
                    </div>
                    <div class="pattern-body">
                        <p class="pattern-description">
                            Found across {{ pattern.files|length }} file{{ 's' if pattern.files|length > 1 else '' }}
                            {% if pattern.files|length <= 3 %}
                            ({{ pattern.files|join(', ') }})
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="supported-patterns-note">
                <p><strong>Note:</strong> These supported patterns are automatically translatable and do not require manual intervention. They are excluded from the detailed gap analysis below to reduce report length.</p>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- ================================================================ -->
    <!-- LAYER 3: IMPLEMENTATION DETAILS                                  -->
    <!-- File-by-file analysis, raw intent, detailed artifacts            -->
    <!-- ================================================================ -->

    <!-- Workflow Inventory -->
    {% if sources %}
    <section class="inventory-section layer-3">
        <div class="container">
            <h2>Source Files</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in sources %}
                    <tr>
                        <td class="file-name">{{ source.name }}</td>
                        <td>
                            {% if source.type == "PowerCLI" %}
                            <span class="badge badge-powercli">PowerCLI</span>
                            {% else %}
                            <span class="badge badge-vrealize">vRealize</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if source.status %}
                            <span class="status-{{ source.status.lower() }}">{{ source.status_icon }} {{ source.status_text }}</span>
                            {% else %}
                            <span class="status-unknown">‚ö† Needs Review</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if source.component_count and source.component_count > 0 %}
                            <a href="#file-{{ source.name | replace('.', '-') }}" class="action-link">View Findings</a>
                            {% else %}
                            <span class="no-action">Review intent</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}

    <!-- Intent Overview -->
    {% if intent %}
    <section class="intent-section layer-3">
        <div class="container">
            <details class="layer-3-collapsible">
                <summary>
                    <h2>Intent Overview</h2>
                </summary>
                <div class="expand-hint-wrapper">
                    <span class="expand-hint">Click to expand detailed workflow information</span>
                </div>

            {% if conflicts_md %}
            <div class="legacy-drift-banner">
                <div class="banner-icon">‚ö†Ô∏è</div>
                <div class="banner-content">
                    <strong>Legacy Drift Detected</strong>
                    <p>Multiple naming conventions, parameter inconsistencies, and policy variations detected across workflows‚Äîcommon in mature automation estates. This analysis surfaced {{ summary.total_components if summary.total_components is defined else ((summary.counts.SUPPORTED or 0) + (summary.counts.PARTIAL or 0) + (summary.counts.BLOCKED or 0) + (summary.counts.MANUAL or 0)) }} individual patterns, revealing technical debt that would otherwise remain hidden until migration.</p>
                </div>
            </div>
            {% endif %}

            <div class="intent-content">
                {% if intent.intent %}
                <!-- Workflow Info -->
                {% if intent.intent.workflow_name %}
                <div class="intent-block">
                    <h3>Workflow</h3>
                    <p><strong>Name:</strong> {{ intent.intent.workflow_name }}</p>
                    {% if intent.intent.workload_type %}
                    <p><strong>Workload Type:</strong> {{ intent.intent.workload_type }}</p>
                    {% endif %}
                    {% if intent.intent.description %}
                    <div class="workflow-description">
                        <h4>Description</h4>
                        <p>{{ intent.intent.description }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- VM Source -->
                {% if intent.intent.vm_source %}
                <div class="intent-block">
                    <h3>VM Image Source</h3>
                    <p><strong>Type:</strong>
                        {% if intent.intent.vm_source.type == 'template' %}
                        <span class="badge badge-info">VM Template</span>
                        {% elif intent.intent.vm_source.type == 'ova' %}
                        <span class="badge badge-info">OVA Import</span>
                        {% elif intent.intent.vm_source.type == 'ovf' %}
                        <span class="badge badge-info">OVF Import</span>
                        {% elif intent.intent.vm_source.type == 'clone' %}
                        <span class="badge badge-info">VM Clone</span>
                        {% elif intent.intent.vm_source.type == 'blank' %}
                        <span class="badge badge-warning">Blank Disk</span>
                        {% else %}
                        {{ intent.intent.vm_source.type }}
                        {% endif %}
                    </p>
                    {% if intent.intent.vm_source.name %}
                    <p><strong>Source:</strong> <code>{{ intent.intent.vm_source.name }}</code></p>
                    {% endif %}
                    {% if intent.intent.vm_source.description %}
                    <p><strong>Description:</strong> {{ intent.intent.vm_source.description }}</p>
                    {% endif %}

                    {% if intent.intent.vm_source.type != 'blank' and intent.intent.vm_source.name %}
                    <!-- Check if template mapping exists -->
                    {% if profile.config.template_mappings and profile.config.template_mappings.get(intent.intent.vm_source.name) %}
                    <div class="info-box info-box-success">
                        <strong>‚úì Mapped to:</strong> <code>{{ profile.config.template_mappings[intent.intent.vm_source.name] }}</code>
                    </div>
                    {% else %}
                    <div class="info-box info-box-warning">
                        <strong>‚ö† No Mapping Configured</strong>
                        <p>This template/image is not mapped in the profile configuration. The generated VM will use a blank disk.</p>
                        <p>Add a mapping in <code>ops-translate.yaml</code>:</p>
                        <pre>profiles:
  {{ profile.name }}:
    template_mappings:
      "{{ intent.intent.vm_source.name }}": "registry:quay.io/containerdisks/centos:8"</pre>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endif %}

                <!-- Inputs -->
                {% if intent.intent.inputs %}
                <div class="intent-block">
                    <h3>Inputs</h3>
                    <ul>
                        {% for input_name, input_spec in intent.intent.inputs.items() %}
                        <li>
                            <code>{{ input_name }}</code>
                            ({{ input_spec.type }})
                            {% if input_spec.required %}
                            <span class="badge badge-required">required</span>
                            {% endif %}
                            {% if input_spec.get('values') %}
                            - values: {{ input_spec.get('values') | join(', ') }}
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Compute -->
                {% if intent.intent.compute %}
                <div class="intent-block">
                    <h3>Compute</h3>
                    {% if intent.intent.compute.cpu_cores %}
                    <p><strong>CPU Cores:</strong> {{ intent.intent.compute.cpu_cores }}</p>
                    {% endif %}
                    {% if intent.intent.compute.memory_mb %}
                    <p><strong>Memory:</strong> {{ intent.intent.compute.memory_mb }} MB</p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Networking -->
                {% if intent.intent.networking %}
                <div class="intent-block">
                    <h3>Networking</h3>
                    {% for net in intent.intent.networking %}
                    <div class="network-item">
                        {% if net.name %}
                        <p><strong>Network:</strong> {{ net.name }}</p>
                        {% endif %}
                        {% if net.type %}
                        <p><strong>Type:</strong> {{ net.type }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Storage -->
                {% if intent.intent.storage %}
                <div class="intent-block">
                    <h3>Storage</h3>
                    {% for disk in intent.intent.storage %}
                    <div class="storage-item">
                        {% if disk.size_gb %}
                        <p><strong>Size:</strong> {{ disk.size_gb }} GB</p>
                        {% endif %}
                        {% if disk.type %}
                        <p><strong>Type:</strong> {{ disk.type }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Governance -->
                {% if intent.intent.governance %}
                <div class="intent-block">
                    <h3>Governance</h3>
                    {% if intent.intent.governance.approval %}
                    <p><strong>Approval Required:</strong>
                        {% if intent.intent.governance.approval.required_when %}
                        When {{ intent.intent.governance.approval.required_when | tojson }}
                        {% else %}
                        Yes
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Show YAML -->
                <details class="yaml-toggle">
                    <summary>Show Raw YAML</summary>
                    <pre><code>{{ intent | tojson(indent=2) }}</code></pre>
                </details>
                {% endif %}
            </div>
            </details>
        </div>
    </section>
    {% else %}
    <section class="intent-section layer-3">
        <div class="container">
            <h2>Intent Overview</h2>
            <div class="alert alert-warning">
                No intent data found. Run <code>ops-translate intent extract</code> to generate intent.
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Gaps & Migration Paths -->
    {% if gaps and gaps.components %}
    <section class="gaps-section layer-3">
        <div class="container">
            <h2>Gaps & Migration Guidance</h2>

            <!-- Filter Indicator -->
            <div id="filter-indicator" class="filter-indicator hidden">
                <span class="filter-text">Filtering by: <strong id="filter-name"></strong></span>
                <button id="clear-filter" class="clear-filter-btn">Clear Filter ‚úï</button>
            </div>

            {% if summary.has_blocking_issues %}
            <div class="alert alert-error">
                <strong>‚ö†Ô∏è Action Required:</strong> This workflow contains components that cannot be automatically translated. Manual implementation or architectural changes will be required.
            </div>
            {% elif summary.requires_manual_work %}
            <div class="alert alert-warning">
                <strong>‚ÑπÔ∏è Manual Configuration Needed:</strong> This workflow can be mostly automated, but some components require manual configuration or review.
            </div>
            {% else %}
            <div class="alert alert-success">
                <strong>‚úÖ Ready for Automatic Translation:</strong> All components in this workflow can be automatically translated to OpenShift-native equivalents.
            </div>
            {% endif %}

            <!-- Migration Path Legend -->
            <div class="migration-legend">
                <h3>Migration Paths</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="badge badge-path-a">PATH A</span>
                        <span class="legend-description">OpenShift-native replacement available - can be automatically translated</span>
                    </div>
                    <div class="legend-item">
                        <span class="badge badge-path-b">PATH B</span>
                        <span class="legend-description">Hybrid approach - keep existing system temporarily while planning migration</span>
                    </div>
                    <div class="legend-item">
                        <span class="badge badge-path-c">PATH C</span>
                        <span class="legend-description">Custom specialist implementation required - significant effort needed</span>
                    </div>
                </div>
            </div>

            <!-- Show/Hide Supported Toggle -->
            <div class="supported-toggle-container">
                <button id="toggle-supported" class="toggle-supported-btn">
                    <span class="toggle-icon">‚ñ∂</span>
                    <span class="toggle-text">Show Supported Patterns</span>
                    <span class="supported-count">({{ gaps.components | selectattr('level', 'equalto', 'SUPPORTED') | list | length }} hidden)</span>
                </button>
                <p class="toggle-note">Supported patterns are hidden by default. See "Standard Supported Patterns" section above for summary.</p>
            </div>

            <!-- Component List -->
            <div class="gaps-list">
                {# Group components by architectural domain instead of file #}
                {% set domain_groups = {
                    'Security & Segmentation': {'icon': 'üîí', 'components': []},
                    'Governance & Approvals': {'icon': '‚úÖ', 'components': []},
                    'Networking': {'icon': 'üåê', 'components': []},
                    'Compute & Storage': {'icon': 'üíæ', 'components': []},
                    'Other Components': {'icon': '‚öôÔ∏è', 'components': []}
                } %}

                {% for comp in gaps.components %}
                    {% set comp_type_lower = comp.component_type.lower() %}
                    {% set comp_name_lower = comp.name.lower() %}
                    {% if 'nsx' in comp_type_lower or 'security' in comp_type_lower or 'firewall' in comp_type_lower or 'nsx' in comp_name_lower %}
                        {% set _ = domain_groups['Security & Segmentation']['components'].append(comp) %}
                    {% elif 'approval' in comp_type_lower or 'governance' in comp_type_lower or 'itsm' in comp_type_lower or 'servicenow' in comp_name_lower %}
                        {% set _ = domain_groups['Governance & Approvals']['components'].append(comp) %}
                    {% elif 'network' in comp_type_lower or 'nic' in comp_type_lower or 'dns' in comp_type_lower or 'multus' in comp_name_lower %}
                        {% set _ = domain_groups['Networking']['components'].append(comp) %}
                    {% elif 'storage' in comp_type_lower or 'disk' in comp_type_lower or 'volume' in comp_type_lower %}
                        {% set _ = domain_groups['Compute & Storage']['components'].append(comp) %}
                    {% else %}
                        {% set _ = domain_groups['Other Components']['components'].append(comp) %}
                    {% endif %}
                {% endfor %}

                {# Render components grouped by domain #}
                {% for domain_name, domain_data in [
                    ('Security & Segmentation', domain_groups['Security & Segmentation']),
                    ('Governance & Approvals', domain_groups['Governance & Approvals']),
                    ('Networking', domain_groups['Networking']),
                    ('Compute & Storage', domain_groups['Compute & Storage']),
                    ('Other Components', domain_groups['Other Components'])
                ] %}
                    {% if domain_data.components | length > 0 %}
                    {# Domain header #}
                    <div class="domain-section-header" id="domain-{{ domain_name | replace(' ', '-') | replace('&', 'and') | lower }}">
                        <div class="domain-icon">{{ domain_data.icon }}</div>
                        <h3>{{ domain_name }}</h3>
                        <span class="domain-count">{{ domain_data.components | length }} component(s)</span>
                    </div>

                    {# Sort components by severity within domain #}
                    {% set sorted_domain_components = domain_data.components | sort(attribute='level') %}
                    {% for component in sorted_domain_components %}
                    <div class="gap-item gap-{{ component.level.lower() }}{% if component.level == 'SUPPORTED' %} supported-hidden{% endif %}" data-level="{{ component.level }}">
                    <div class="gap-header">
                        <h3>
                            {{ component.name }}
                            {# Add vRealize-specific indicators #}
                            {% if 'approval' in component.component_type %}
                            <span class="vrealize-indicator" title="vRealize Approval Workflow">‚öôÔ∏è Approval</span>
                            {% endif %}
                            {% if 'orchestration' in component.component_type %}
                            <span class="vrealize-indicator" title="vRealize Orchestration Complexity">üîÑ Orchestration</span>
                            {% endif %}
                            {% if 'vro_plugin' in component.component_type or 'vro_' in component.component_type %}
                            <span class="vrealize-indicator" title="vRO Plugin/Integration">üîå vRO Plugin</span>
                            {% endif %}
                            {% if 'nsx' in component.component_type %}
                            <span class="vrealize-indicator vrealize-indicator-nsx" title="NSX-T Component">üîí NSX-T</span>
                            {% endif %}
                        </h3>
                        <span class="badge badge-{{ component.level.lower() }}">{{ component.level }}</span>
                    </div>
                    <div class="gap-body">
                        <p><strong>Type:</strong> {{ component.component_type }}</p>
                        {% if component.location %}
                        <p><strong>Location:</strong> <code>{{ component.location }}</code></p>
                        {% endif %}
                        <p><strong>Reason:</strong> {{ component.reason }}</p>

                        {% if component.openshift_equivalent %}
                        <p><strong>OpenShift Equivalent:</strong> {{ component.openshift_equivalent }}</p>
                        {% endif %}

                        {% if component.migration_path %}
                        <p><strong>Migration Path:</strong>
                            {% if component.migration_path == "PATH_A" %}
                            <span class="badge badge-path-a">PATH A</span>
                            <span class="path-description">OpenShift-native replacement available</span>
                            {% elif component.migration_path == "PATH_B" %}
                            <span class="badge badge-path-b">PATH B</span>
                            <span class="path-description">Hybrid approach - keep existing temporarily</span>
                            {% elif component.migration_path == "PATH_C" %}
                            <span class="badge badge-path-c">PATH C</span>
                            <span class="path-description">Custom specialist implementation required</span>
                            {% else %}
                            <span class="badge badge-path">{{ component.migration_path }}</span>
                            {% endif %}
                        </p>
                        {% endif %}

                        {% if component.recommendations %}
                        <div class="recommendations">
                            <strong>Recommendations:</strong>
                            <ul>
                                {% for rec in component.recommendations %}
                                <li>{{ rec }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if component.evidence %}
                        <details class="evidence-toggle">
                            <summary>Show Evidence</summary>
                            <pre><code>{{ component.evidence }}</code></pre>
                        </details>
                        {% endif %}

                        {# Interview Questions - shown only for PARTIAL/BLOCKED/MANUAL components #}
                        {% if component.location and component.location in questions_by_location and component.level in ['PARTIAL', 'BLOCKED', 'MANUAL'] %}
                        {% set component_questions = questions_by_location[component.location] %}
                        <details class="interview-toggle">
                            <summary>üí° Answer Questions to Unlock Automation</summary>
                            <div class="interview-section">
                                <p class="interview-intro">
                                    Help us understand your requirements. Your answers will determine if this component can be automatically translated.
                                </p>

                                {% for question in component_questions %}
                                <div class="interview-question" data-question-id="{{ question.id }}">
                                    <h4>{{ question.prompt }}</h4>
                                    <div class="interview-options">
                                        {% for option in question.options %}
                                        <label class="interview-option">
                                            <input type="radio"
                                                   name="{{ question.id }}"
                                                   value="{{ option.value }}"
                                                   data-impact="{{ option.impact | default('') }}">
                                            <div class="option-content">
                                                <div class="option-label">{{ option.label }}</div>
                                                {% if option.description %}
                                                <div class="option-description">{{ option.description }}</div>
                                                {% endif %}
                                                {% if option.impact %}
                                                <div class="option-impact">‚Üí {{ option.impact }}</div>
                                                {% endif %}
                                            </div>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}

                                <div class="interview-actions">
                                    <button class="interview-generate-yaml" data-component-location="{{ component.location }}">
                                        Generate answers.yaml Snippet
                                    </button>
                                </div>

                                <div class="interview-yaml-output" style="display: none;">
                                    <h4>Add to intent/answers.yaml:</h4>
                                    <pre><code class="yaml-snippet"></code></pre>
                                    <button class="copy-yaml-btn">Copy to Clipboard</button>
                                </div>
                            </div>
                        </details>
                        {% endif %}

                        {# Expert Implementation Guide - shown for PARTIAL/BLOCKED/MANUAL components #}
                        {% if component.name in recommendations_by_component and component.level in ['PARTIAL', 'BLOCKED', 'MANUAL'] %}
                        {% set rec = recommendations_by_component[component.name] %}
                        <details class="recommendation-toggle">
                            <summary>üìñ Expert Implementation Guide</summary>
                            <div class="recommendation-section">
                                <div class="recommendation-header">
                                    <span class="recommendation-owner-badge">Owner: {{ rec.owner }}</span>
                                </div>

                                <div class="recommendation-block">
                                    <h4>Why Not Auto-Translatable</h4>
                                    <p>{{ rec.reason_not_auto_translatable }}</p>
                                </div>

                                <div class="recommendation-block">
                                    <h4>Recommended Ansible Approach</h4>
                                    <p>{{ rec.ansible_approach }}</p>
                                </div>

                                <div class="recommendation-block">
                                    <h4>OpenShift/Kubernetes Primitives</h4>
                                    <ul class="primitives-list">
                                        {% for primitive in rec.openshift_primitives %}
                                        <li><code>{{ primitive }}</code></li>
                                        {% endfor %}
                                    </ul>
                                </div>

                                <div class="recommendation-block">
                                    <h4>Implementation Steps</h4>
                                    <ol class="implementation-steps">
                                        {% for step in rec.implementation_steps %}
                                        <li>{{ step }}</li>
                                        {% endfor %}
                                    </ol>
                                </div>

                                <div class="recommendation-block">
                                    <h4>Required Inputs</h4>
                                    {% if rec.required_inputs %}
                                    <table class="inputs-table">
                                        <thead>
                                            <tr>
                                                <th>Variable</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for var_name, description in rec.required_inputs.items() %}
                                            <tr>
                                                <td><code>{{ var_name }}</code></td>
                                                <td>{{ description }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% else %}
                                    <p class="no-inputs">No specific inputs required</p>
                                    {% endif %}
                                </div>

                                <div class="recommendation-block">
                                    <h4>Testing & Validation</h4>
                                    <p>{{ rec.testing_guidance }}</p>
                                </div>

                                {% if rec.references %}
                                <div class="recommendation-block">
                                    <h4>References</h4>
                                    <ul class="references-list">
                                        {% for reference in rec.references %}
                                        <li><a href="{{ reference }}" target="_blank" rel="noopener">{{ reference }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                {% if rec.ansible_role_stub %}
                                <div class="recommendation-block ansible-scaffolding">
                                    <h4>üõ†Ô∏è Ansible Scaffolding Generated</h4>
                                    <p>A role stub with implementation guidance has been created at:</p>
                                    <code class="role-path">output/ansible/roles/{{ rec.ansible_role_stub }}/</code>
                                    <p class="scaffolding-note">See the role's README.md for detailed implementation guidance.</p>
                                </div>
                                {% endif %}
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {# End of components loop #}

                    {% endif %}
                {% endfor %}
                {# End of domain groups loop #}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Hybrid Retention Section -->
    {% if gaps and gaps.components %}
    {% set hybrid_components = [] %}
    {% for component in gaps.components %}
        {% if component.migration_path == "PATH_B" %}
            {% set _ = hybrid_components.append(component) %}
        {% endif %}
    {% endfor %}
    {% if hybrid_components %}
    <section class="hybrid-section layer-3">
        <div class="container">
            <h2>What Stays in VMware / NSX (Hybrid Approach)</h2>

            <div class="hybrid-intro">
                <p><strong>Hybrid architectures are a valid migration strategy.</strong> The following components can remain in your existing VMware/NSX environment while you migrate workloads to OpenShift.</p>
            </div>

            <div class="hybrid-list">
                {% for component in hybrid_components %}
                <div class="hybrid-item">
                    <div class="hybrid-header">
                        <h3>{{ component.name }}</h3>
                        <span class="badge badge-path-b">PATH B</span>
                    </div>
                    <p class="hybrid-reason">{{ component.reason }}</p>
                    {% if component.recommendations %}
                    <div class="hybrid-guidance">
                        <strong>Hybrid Integration:</strong>
                        <ul>
                            {% for rec in component.recommendations[:3] %}
                            <li>{{ rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="hybrid-footer">
                <p>üí° <strong>Why Hybrid?</strong> Retaining proven infrastructure reduces migration risk and allows incremental modernization. You can evaluate OpenShift-native alternatives on your timeline.</p>
            </div>
        </div>
    </section>
    {% endif %}
    {% endif %}

        </div>
        <!-- End Architecture & Gaps Tab -->

        <!-- Implementation Tab -->
        <div id="tab-implementation" class="tab-panel" role="tabpanel" aria-labelledby="tab-implementation">

    <!-- Start Here Section -->
    <section class="start-here-section">
        <div class="container">
            <div class="start-here-box">
                <h2>üöÄ Start Here</h2>
                <p class="start-here-intro">
                    This tab contains everything you need to implement the migration. Follow these steps in order.
                </p>

                <div class="implementation-steps-grid">
                    <div class="impl-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Review Generated Artifacts</h3>
                            <p>Examine the Ansible playbooks and KubeVirt manifests below</p>
                        </div>
                    </div>
                    <div class="impl-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Validate Configuration</h3>
                            <p>Run <code>ops-translate dry-run</code> to check for issues</p>
                        </div>
                    </div>
                    <div class="impl-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Deploy to Lab</h3>
                            <p>Apply manifests in a non-production environment first</p>
                        </div>
                    </div>
                    <div class="impl-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Verify & Test</h3>
                            <p>Use the Definition-of-Done checklist below</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Definition of Done -->
    <section class="dod-section">
        <div class="container">
            <h2>‚úÖ Definition of Done</h2>
            <p class="section-subtitle">Check off these items before promoting to production:</p>

            <div class="dod-checklist">
                <div class="dod-category">
                    <h3>üß™ Testing</h3>
                    <ul class="dod-items">
                        <li><input type="checkbox" disabled> VMs boot successfully in lab environment</li>
                        <li><input type="checkbox" disabled> Network connectivity verified (all NICs functional)</li>
                        <li><input type="checkbox" disabled> Storage volumes attached and accessible</li>
                        <li><input type="checkbox" disabled> Ansible playbooks execute without errors</li>
                        {% if gaps and gaps.components | selectattr('level', 'equalto', 'BLOCKED') | list | length > 0 %}
                        <li><input type="checkbox" disabled> Custom implementations tested for BLOCKED components</li>
                        {% endif %}
                    </ul>
                </div>

                <div class="dod-category">
                    <h3>üìã Documentation</h3>
                    <ul class="dod-items">
                        <li><input type="checkbox" disabled> Runbooks created for operational tasks</li>
                        <li><input type="checkbox" disabled> Architectural decisions documented</li>
                        <li><input type="checkbox" disabled> Custom role implementations documented</li>
                        {% if assumptions_md %}
                        <li><input type="checkbox" disabled> Assumptions validated with stakeholders</li>
                        {% endif %}
                    </ul>
                </div>

                <div class="dod-category">
                    <h3>üîí Security & Compliance</h3>
                    <ul class="dod-items">
                        <li><input type="checkbox" disabled> NetworkPolicies reviewed and approved</li>
                        <li><input type="checkbox" disabled> RBAC permissions validated</li>
                        <li><input type="checkbox" disabled> Secret management strategy confirmed</li>
                        {% if gaps and gaps.components | selectattr('component_type', 'defined') | list | length > 0 %}
                        {% set has_approval = namespace(found=false) %}
                        {% for comp in gaps.components %}
                            {% if 'approval' in comp.component_type.lower() %}
                                {% set has_approval.found = true %}
                            {% endif %}
                        {% endfor %}
                        {% if has_approval.found %}
                        <li><input type="checkbox" disabled> Approval workflows configured and tested</li>
                        {% endif %}
                        {% endif %}
                    </ul>
                </div>

                <div class="dod-category">
                    <h3>üéØ Acceptance Criteria</h3>
                    <ul class="dod-items">
                        <li><input type="checkbox" disabled> All functional requirements met</li>
                        <li><input type="checkbox" disabled> Performance acceptable (CPU, memory, I/O)</li>
                        <li><input type="checkbox" disabled> Monitoring and alerting configured</li>
                        <li><input type="checkbox" disabled> Rollback plan tested and documented</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Generated Artifacts -->
    {% if artifacts.kubevirt or artifacts.ansible %}
    <section class="artifacts-section layer-3">
        <div class="container">
            <details class="layer-3-collapsible">
                <summary>
                    <h2>Generated Artifacts</h2>
                </summary>
                <div class="expand-hint-wrapper">
                    <span class="expand-hint">Click to expand artifact details</span>
                </div>

            {% if artifacts.kubevirt %}
            <div class="artifact-group">
                <h3>KubeVirt Manifests</h3>
                <ul class="artifact-list">
                    {% for artifact in artifacts.kubevirt %}
                    <li>
                        <span class="artifact-name">{{ artifact.name }}</span>
                        <span class="artifact-path">{{ artifact.path }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if artifacts.ansible %}
            <div class="artifact-group">
                <h3>Ansible Playbooks & Roles</h3>
                <ul class="artifact-list">
                    {% for artifact in artifacts.ansible %}
                    <li>
                        <span class="artifact-name">{{ artifact.name }}</span>
                        <span class="artifact-path">{{ artifact.path }}</span>
                        {% if artifact.type == "role" and artifact.name.startswith("role: custom_") %}
                        <span class="badge badge-warning">Manual Work Required</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- What's Next Checklist -->
            <div class="next-steps">
                <h3>What's Next?</h3>
                <ul class="checklist">
                    {% if gaps and gaps.components %}
                    <li>Review gaps and migration guidance above</li>
                    {% endif %}
                    {% if assumptions_md %}
                    <li>Review assumptions (see below)</li>
                    {% endif %}
                    <li>Run <code>ops-translate dry-run</code> to validate configuration</li>
                    <li>Apply generated artifacts in a lab environment first</li>
                    <li>Test functionality before promoting to production</li>
                </ul>
            </div>
            </details>
        </div>
    </section>
    {% else %}
    <section class="artifacts-section layer-3">
        <div class="container">
            <h2>Generated Artifacts</h2>
            <div class="alert alert-info">
                No artifacts generated yet. Run <code>ops-translate generate --profile {{ profile.name }}</code> to generate KubeVirt and Ansible artifacts.
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Assumptions -->
    {% if assumptions_md %}
    <section class="appendix-section layer-3">
        <div class="container">
            <details class="appendix-content">
                <summary><h2>Assumptions</h2></summary>
                <div class="markdown-content">
                    {{ assumptions_md | safe }}
                </div>
            </details>
        </div>
    </section>
    {% endif %}

    <!-- Conflicts -->
    {% if conflicts_md %}
    <section class="appendix-section layer-3">
        <div class="container">
            <details class="appendix-content">
                <summary><h2>Conflicts</h2></summary>
                <div class="conflicts-impact">
                    <strong>Impact:</strong> These conflicts do not block migration, but must be resolved for clean parameter validation and artifact generation.
                </div>
                <div class="markdown-content alert-warning">
                    {{ conflicts_md | safe }}
                </div>
            </details>
        </div>
    </section>
    {% endif %}

        </div>
        <!-- End Implementation Tab -->

    </div>
    <!-- End Tab Panels -->

    <!-- Footer -->
    <footer class="report-footer">
        <div class="container">
            <p>Generated by <strong>ops-translate</strong> at {{ workspace.timestamp[:19] }}</p>
            <p class="disclaimer">This report is read-only and for review purposes. No changes will be applied automatically.</p>
        </div>
    </footer>

    <script>
        // Pass gaps data to JavaScript for CSV export
        window.reportData = {
            workspace: "{{ workspace.name }}",
            timestamp: "{{ workspace.timestamp[:19] }}",
            gaps: {{ gaps | tojson | safe if gaps else '{}' }}
        };
    </script>
    <script src="assets/app.js"></script>
</body>
</html>
