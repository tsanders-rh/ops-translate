---
# Ansible playbook generated by ops-translate
# Workflow: {{ intent.workflow_name }}
# Generated: {{ timestamp }}

- name: {{ intent.workflow_name | replace('_', ' ') | title }}
  hosts: localhost
  gather_facts: false

  vars:
    # Workflow configuration
    workflow_name: "{{ intent.workflow_name }}"
    workload_type: "{{ intent.workload_type | default('virtual_machine') }}"

    # Profile settings
    target_namespace: "{{ profile.default_namespace | default('default') }}"
    target_network: "{{ profile.default_network | default('pod-network') }}"
    storage_class: "{{ profile.default_storage_class | default('standard') }}"

    # Input variables
{% for input_name, input_spec in intent.inputs.items() %}
    {{ input_name }}: "{{ '{{' }} {{ input_name }} {{ '}}' }}"  # {{ input_spec.type }}{% if input_spec.required %} (required){% endif %}
{% endfor %}

  tasks:
    - name: Validate required inputs
      ansible.builtin.assert:
        that:
{% for input_name, input_spec in intent.inputs.items() %}
{% if input_spec.required %}
          - {{ input_name }} is defined
          - {{ input_name }} | length > 0
{% endif %}
{% endfor %}
        fail_msg: "Missing required input variables"
      tags: [validate]

{% if intent.governance and intent.governance.approval %}
    - name: Check approval requirements
      ansible.builtin.debug:
        msg: "Approval required for this workflow"
      when:
{% for key, value in intent.governance.approval.get('required_when', {}).items() %}
        - {{ key }} == "{{ value }}"
{% endfor %}
      tags: [approval]
{% endif %}

    - name: Apply KubeVirt resources
      community.kubevirt.kubevirt_vm:
        state: present
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
        name: "{{ '{{' }} vm_name | default(workflow_name) {{ '}}' }}"
        wait: true
      register: vm_result
      tags: [provision]

    - name: Display provisioning result
      ansible.builtin.debug:
        var: vm_result
      tags: [provision]
