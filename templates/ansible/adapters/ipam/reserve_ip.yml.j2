---
# IPAM IP Address Reservation adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.ipam and profile.ipam.provider == 'infoblox' and profile.ipam.endpoint %}
- name: "Get next available IP from Infoblox network {{ '{{' }} ipam_network {{ '}}' }}"
  uri:
    url: "{{ profile.ipam.endpoint }}/wapi/v2.11/network/{{ '{{' }} ipam_network_ref {{ '}}' }}?_function=next_available_ip"
    method: POST
    user: "{{ '{{' }} {{ profile.ipam.credentials_var }}_username {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.ipam.credentials_var }}_password {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      num: 1
    status_code: 200
    return_content: yes
  register: infoblox_ip_result

- name: Extract allocated IP address
  ansible.builtin.set_fact:
    allocated_ip_address: "{{ '{{' }} infoblox_ip_result.json.ips[0] {{ '}}' }}"

- name: "Reserve IP address in Infoblox: {{ '{{' }} allocated_ip_address {{ '}}' }}"
  uri:
    url: "{{ profile.ipam.endpoint }}/wapi/v2.11/record:host"
    method: POST
    user: "{{ '{{' }} {{ profile.ipam.credentials_var }}_username {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.ipam.credentials_var }}_password {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "{{ '{{' }} host_name {{ '}}' }}"
      ipv4addrs:
        - ipv4addr: "{{ '{{' }} allocated_ip_address {{ '}}' }}"
          configure_for_dhcp: false
      comment: "Reserved by ops-translate for {{ '{{' }} host_name {{ '}}' }}"
    status_code: 201
    return_content: yes
  register: reservation_result

- name: Display IP reservation result
  ansible.builtin.debug:
    msg: "Infoblox: Reserved IP {{ '{{' }} allocated_ip_address {{ '}}' }} for {{ '{{' }} host_name {{ '}}' }}"
{% elif profile.ipam and profile.ipam.provider == 'whereabouts' %}
- name: "Configure Whereabouts IPAM for pod {{ '{{' }} pod_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: "{{ '{{' }} pod_name {{ '}}' }}"
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
        annotations:
          k8s.v1.cni.cncf.io/networks: |
            [
              {
                "name": "{{ '{{' }} network_attachment_name {{ '}}' }}",
                "namespace": "{{ '{{' }} target_namespace {{ '}}' }}",
                "ips": ["{{ '{{' }} requested_ip | default('') {{ '}}' }}"],
                "ipam": {
                  "type": "whereabouts",
                  "range": "{{ '{{' }} ipam_network {{ '}}' }}",
                  "range_start": "{{ '{{' }} range_start | default('') {{ '}}' }}",
                  "range_end": "{{ '{{' }} range_end | default('') {{ '}}' }}"
                }
              }
            ]
      spec:
        containers:
          - name: placeholder
            image: registry.access.redhat.com/ubi8/ubi-minimal:latest
  register: whereabouts_result

- name: Display Whereabouts IPAM configuration result
  ansible.builtin.debug:
    msg: "Whereabouts IPAM configured for {{ '{{' }} pod_name {{ '}}' }} on network {{ '{{' }} ipam_network {{ '}}' }}"
{% elif profile.ipam and profile.ipam.provider == 'static' %}
- name: "Use static IP allocation for {{ '{{' }} host_name {{ '}}' }}"
  ansible.builtin.set_fact:
    allocated_ip_address: "{{ '{{' }} static_ip_address {{ '}}' }}"

- name: Display static IP allocation
  ansible.builtin.debug:
    msg: "Static IP allocated: {{ '{{' }} allocated_ip_address {{ '}}' }} for {{ '{{' }} host_name {{ '}}' }}"
  when: static_ip_address is defined

- name: Fail if static IP not provided
  ansible.builtin.fail:
    msg: |
      Static IPAM provider configured, but no static_ip_address variable provided.
      Please set static_ip_address in your playbook variables or inventory.
  when: static_ip_address is not defined
{% else %}
- name: "BLOCKED: IP address allocation required but IPAM not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: IPAM (IP Address Management) Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires IP address allocation from an IPAM system, but your
      profile does not have IPAM integration configured.

      TO FIX THIS:
      Add IPAM configuration to your profile.yml:

        ipam:
          provider: infoblox                  # or: whereabouts, static
          endpoint: https://infoblox.acme.com
          credentials_var: infoblox_creds     # Ansible variable name

      Supported IPAM providers:
        - infoblox: Infoblox IPAM/DHCP platform
          Requires: endpoint, credentials_var (username/password)
          Features:
            - Allocates next available IP from network
            - Creates host record reservation
            - Supports DHCP reservation
            - Returns allocated IP address

        - whereabouts: Whereabouts CNI IPAM plugin
          No endpoint required - uses Kubernetes CNI
          Features:
            - Cluster-scoped IP address management
            - Automatic allocation from defined ranges
            - Supports static IP requests
            - Integrates with multus-cni

        - static: Static IP allocation from playbook variables
          No endpoint required - uses playbook vars
          Features:
            - Manual IP address specification
            - Requires static_ip_address variable
            - No conflict detection
            - Simple for small deployments

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
