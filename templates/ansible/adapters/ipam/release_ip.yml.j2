---
# IPAM IP Address Release adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.ipam and profile.ipam.provider == 'infoblox' and profile.ipam.endpoint %}
- name: "Find host record for {{ '{{' }} host_name {{ '}}' }} in Infoblox"
  uri:
    url: "{{ profile.ipam.endpoint }}/wapi/v2.11/record:host?name={{ '{{' }} host_name {{ '}}' }}"
    method: GET
    user: "{{ '{{' }} {{ profile.ipam.credentials_var }}_username {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.ipam.credentials_var }}_password {{ '}}' }}"
    force_basic_auth: yes
    status_code: 200
    return_content: yes
  register: infoblox_host_search
  failed_when: false

- name: "Delete host record from Infoblox if found"
  uri:
    url: "{{ profile.ipam.endpoint }}/wapi/v2.11/{{ '{{' }} infoblox_host_search.json[0]._ref {{ '}}' }}"
    method: DELETE
    user: "{{ '{{' }} {{ profile.ipam.credentials_var }}_username {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.ipam.credentials_var }}_password {{ '}}' }}"
    force_basic_auth: yes
    status_code: 200
  when:
    - infoblox_host_search.json is defined
    - infoblox_host_search.json | length > 0
  register: release_result

- name: Display IP release result
  ansible.builtin.debug:
    msg: "Infoblox: Released IP address for {{ '{{' }} host_name {{ '}}' }}"
  when:
    - release_result is changed

- name: No host record found to release
  ansible.builtin.debug:
    msg: "Infoblox: No host record found for {{ '{{' }} host_name {{ '}}' }}, nothing to release"
  when:
    - infoblox_host_search.json is defined
    - infoblox_host_search.json | length == 0
{% elif profile.ipam and profile.ipam.provider == 'whereabouts' %}
- name: "Release Whereabouts IPAM allocation for pod {{ '{{' }} pod_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    name: "{{ '{{' }} pod_name {{ '}}' }}"
    namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
  register: whereabouts_release_result

- name: Display Whereabouts IP release result
  ansible.builtin.debug:
    msg: |
      Whereabouts IPAM: Pod {{ '{{' }} pod_name {{ '}}' }} deleted.
      IP address will be returned to the pool automatically.

- name: "NOTICE: Whereabouts IP release behavior"
  ansible.builtin.debug:
    msg: |
      Whereabouts automatically releases IP addresses when pods are deleted.
      No additional cleanup is required.
{% elif profile.ipam and profile.ipam.provider == 'static' %}
- name: "NOTICE: Static IP release"
  ansible.builtin.debug:
    msg: |
      Static IPAM provider configured - no automatic IP release mechanism.

      The IP address {{ '{{' }} static_ip_address | default('(unknown)') {{ '}}' }} for {{ '{{' }} host_name {{ '}}' }}
      was manually allocated and must be manually returned to the available pool.

      Please update your IP allocation tracking system to mark this IP as available.
{% else %}
- name: "BLOCKED: IP address release required but IPAM not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: IPAM (IP Address Release) Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires IP address release/deallocation from an IPAM system,
      but your profile does not have IPAM integration configured.

      TO FIX THIS:
      Add IPAM configuration to your profile.yml:

        ipam:
          provider: infoblox                  # or: whereabouts, static
          endpoint: https://infoblox.acme.com
          credentials_var: infoblox_creds     # Ansible variable name

      Supported IPAM providers:
        - infoblox: Infoblox IPAM/DHCP platform
          Requires: endpoint, credentials_var (username/password)
          Release behavior:
            - Finds host record by hostname
            - Deletes host record and IP reservation
            - Returns IP to available pool
            - Removes DHCP reservation if configured

        - whereabouts: Whereabouts CNI IPAM plugin
          No endpoint required - uses Kubernetes CNI
          Release behavior:
            - Automatically releases IP when pod is deleted
            - No manual cleanup required
            - IP returned to cluster pool

        - static: Static IP allocation from playbook variables
          No endpoint required - uses playbook vars
          Release behavior:
            - No automatic release mechanism
            - Requires manual IP tracking updates
            - Simple for small deployments

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
