---
# Generic REST API Call adapter
# Generated by ops-translate from profile: {{ profile.name }}

- name: "Execute REST API call: {{ '{{' }} rest_method | upper {{ '}}' }} {{ '{{' }} rest_endpoint {{ '}}' }}"
  uri:
    url: "{{ '{{' }} rest_base_url {{ '}}' }}{{ '{{' }} rest_endpoint {{ '}}' }}"
    method: "{{ '{{' }} rest_method | upper {{ '}}' }}"
    {% if rest_auth_type is defined and rest_auth_type == 'basic' %}
    user: "{{ '{{' }} rest_username {{ '}}' }}"
    password: "{{ '{{' }} rest_password {{ '}}' }}"
    force_basic_auth: yes
    {% elif rest_auth_type is defined and rest_auth_type == 'token' %}
    headers:
      Authorization: "Bearer {{ '{{' }} rest_auth_token {{ '}}' }}"
    {% elif rest_auth_type is defined and rest_auth_type == 'apikey' %}
    headers:
      X-API-Key: "{{ '{{' }} rest_api_key {{ '}}' }}"
    {% elif rest_headers is defined %}
    headers: "{{ '{{' }} rest_headers {{ '}}' }}"
    {% endif %}
    {% if rest_body is defined %}
    body_format: json
    body: "{{ '{{' }} rest_body {{ '}}' }}"
    {% endif %}
    status_code: "{{ '{{' }} expected_status_code | default([200, 201, 202, 204]) {{ '}}' }}"
    return_content: yes
    validate_certs: "{{ '{{' }} validate_certs | default(true) {{ '}}' }}"
    timeout: "{{ '{{' }} rest_timeout | default(30) {{ '}}' }}"
  register: rest_api_result
  failed_when: false

- name: Display REST API call result
  ansible.builtin.debug:
    msg: |
      REST API Call Complete:
        Method: {{ '{{' }} rest_method | upper {{ '}}' }}
        Endpoint: {{ '{{' }} rest_endpoint {{ '}}' }}
        Status: {{ '{{' }} rest_api_result.status {{ '}}' }}
        {% if rest_api_result.json is defined %}
        Response: {{ '{{' }} rest_api_result.json | to_nice_json {{ '}}' }}
        {% endif %}

- name: Verify REST API call succeeded
  ansible.builtin.assert:
    that:
      - rest_api_result.status in expected_status_code | default([200, 201, 202, 204])
    fail_msg: |
      REST API call failed:
        Method: {{ '{{' }} rest_method | upper {{ '}}' }}
        Endpoint: {{ '{{' }} rest_endpoint {{ '}}' }}
        Status: {{ '{{' }} rest_api_result.status {{ '}}' }}
        Message: {{ '{{' }} rest_api_result.msg | default('Unknown error') {{ '}}' }}
    success_msg: "REST API call succeeded ({{ '{{' }} rest_api_result.status {{ '}}' }})"

- name: Store REST API response data
  ansible.builtin.set_fact:
    rest_response_data: "{{ '{{' }} rest_api_result.json | default({}) {{ '}}' }}"
    rest_response_status: "{{ '{{' }} rest_api_result.status {{ '}}' }}"
    rest_response_headers: "{{ '{{' }} rest_api_result.response_headers | default({}) {{ '}}' }}"

- name: "USAGE NOTICE: Generic REST adapter"
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      Generic REST API Adapter Usage
      ═══════════════════════════════════════════════════════════════════════════════

      This adapter executes arbitrary REST API calls. Required variables:

      REQUIRED:
        rest_base_url: "https://api.example.com"
        rest_endpoint: "/v1/resource"
        rest_method: "GET"  # or POST, PUT, DELETE, PATCH

      AUTHENTICATION (choose one):
        Basic Auth:
          rest_auth_type: "basic"
          rest_username: "{{ '{{' }} username {{ '}}' }}"
          rest_password: "{{ '{{' }} password {{ '}}' }}"

        Bearer Token:
          rest_auth_type: "token"
          rest_auth_token: "{{ '{{' }} token {{ '}}' }}"

        API Key:
          rest_auth_type: "apikey"
          rest_api_key: "{{ '{{' }} api_key {{ '}}' }}"

        Custom Headers:
          rest_headers:
            Authorization: "Custom {{ '{{' }} auth_value {{ '}}' }}"
            X-Custom-Header: "value"

      OPTIONAL:
        rest_body:
          key: "value"
        expected_status_code: [200, 201]
        rest_timeout: 30
        validate_certs: true

      RESPONSE:
        Access response data via:
          - rest_response_data (JSON body)
          - rest_response_status (HTTP status code)
          - rest_response_headers (HTTP headers)

      EXAMPLE:
        - name: Call external API
          include_tasks: adapters/rest/generic_call.yml
          vars:
            rest_base_url: "https://api.acme.com"
            rest_endpoint: "/v2/provision"
            rest_method: "POST"
            rest_auth_type: "token"
            rest_auth_token: "{{ '{{' }} vault_api_token {{ '}}' }}"
            rest_body:
              name: "{{ '{{' }} vm_name {{ '}}' }}"
              size: "{{ '{{' }} vm_size {{ '}}' }}"
      ═══════════════════════════════════════════════════════════════════════════════
  run_once: true
  when: show_usage_notice | default(false)
