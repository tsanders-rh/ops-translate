---
# NSX Firewall Rule to NetworkPolicy adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.network_security and profile.network_security.model != 'blocked' %}
{% if profile.network_security.model == 'calico' %}
- name: "Create Calico NetworkPolicy for firewall rule {{ '{{' }} rule_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: projectcalico.org/v3
      kind: NetworkPolicy
      metadata:
        name: "{{ '{{' }} rule_name {{ '}}' }}"
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
        annotations:
          description: "Translated from NSX-T firewall rule: {{ '{{' }} rule_name {{ '}}' }}"
      spec:
        selector: "{{ '{{' }} destination_group | default('all()') {{ '}}' }}"
        types:
          - Ingress
        ingress:
          - action: "{{ '{{' }} action | default('Allow') {{ '}}' }}"
            source:
              selector: "{{ '{{' }} source_group | default('all()') {{ '}}' }}"
{% if ports is defined %}
            destination:
              ports:
{% for port in ports %}
                - {{ port }}
{% endfor %}
{% endif %}
{% elif profile.network_security.model == 'cilium' %}
- name: "Create Cilium NetworkPolicy for firewall rule {{ '{{' }} rule_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cilium.io/v2
      kind: CiliumNetworkPolicy
      metadata:
        name: "{{ '{{' }} rule_name {{ '}}' }}"
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
      spec:
        endpointSelector:
          matchLabels: "{{ '{{' }} destination_labels | default({}) {{ '}}' }}"
        ingress:
          - fromEndpoints:
              - matchLabels: "{{ '{{' }} source_labels | default({}) {{ '}}' }}"
{% if ports is defined %}
            toPorts:
{% for port in ports %}
              - ports:
                  - port: "{{ port }}"
                    protocol: TCP
{% endfor %}
{% endif %}
{% else %}
- name: "Create Kubernetes NetworkPolicy for firewall rule {{ '{{' }} rule_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: "{{ '{{' }} rule_name {{ '}}' }}"
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
        annotations:
          description: "Translated from NSX-T firewall rule: {{ '{{' }} rule_name {{ '}}' }}"
      spec:
        podSelector:
          matchLabels: "{{ '{{' }} destination_labels | default({}) {{ '}}' }}"
        policyTypes:
          - Ingress
        ingress:
          - from:
              - podSelector:
                  matchLabels: "{{ '{{' }} source_labels | default({}) {{ '}}' }}"
{% if ports is defined %}
            ports:
{% for port in ports %}
              - protocol: TCP
                port: {{ port }}
{% endfor %}
{% endif %}
{% endif %}
  register: firewall_result

- name: Display firewall rule creation result
  ansible.builtin.debug:
    msg: "NetworkPolicy created: {{ '{{' }} firewall_result.result.metadata.name {{ '}}' }}"
{% else %}
- name: "BLOCKED: NSX firewall rule creation - network_security profile not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: NSX Firewall Rule Creation
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires NSX-T distributed firewall rule creation, which
      translates to NetworkPolicy in Kubernetes. However, your profile does not
      have network_security configured.

      TO FIX THIS:
      Add network_security configuration to your profile.yml:

        network_security:
          model: networkpolicy          # or: calico, cilium, istio
          default_isolation: namespace  # or: pod, none

      Supported models for firewall rule translation:
        - networkpolicy: Standard Kubernetes NetworkPolicy
        - calico: Calico NetworkPolicy with advanced features
        - cilium: Cilium NetworkPolicy with eBPF enforcement
        - istio: Istio AuthorizationPolicy (L7 aware)

      NetworkPolicy enforces pod-to-pod communication rules similar to NSX-T
      distributed firewall, but uses label selectors instead of security groups.

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
