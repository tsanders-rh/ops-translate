---
# NSX Segment to NetworkAttachmentDefinition adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.network_security and profile.network_security.model != 'blocked' %}
- name: "Create NetworkAttachmentDefinition for segment {{ '{{' }} segment_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.cni.cncf.io/v1
      kind: NetworkAttachmentDefinition
      metadata:
        name: "{{ '{{' }} segment_name {{ '}}' }}"
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
        annotations:
          description: "Translated from NSX-T segment: {{ '{{' }} segment_name {{ '}}' }}"
{% if profile.network_security.model == 'calico' %}
          # Calico-specific configuration
          cni.projectcalico.org/ipv4pools: '["default-ipv4-ippool"]'
{% elif profile.network_security.model == 'cilium' %}
          # Cilium-specific configuration
          cilium.io/ipam-mode: cluster-pool
{% endif %}
      spec:
        config: |-
          {
            "cniVersion": "0.3.1",
            "type": "{{ profile.network_security.model }}",
            "name": "{{ '{{' }} segment_name {{ '}}' }}",
{% if transport_zone is defined %}
            "transportZone": "{{ '{{' }} transport_zone {{ '}}' }}",
{% endif %}
            "ipam": {
              "type": "host-local",
              "subnet": "{{ '{{' }} segment_subnet | default('10.0.0.0/24') {{ '}}' }}"
            }
          }
  register: segment_result

- name: Display segment creation result
  ansible.builtin.debug:
    msg: "NetworkAttachmentDefinition created: {{ '{{' }} segment_result.result.metadata.name {{ '}}' }}"
{% else %}
- name: "BLOCKED: NSX segment creation - network_security profile not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: NSX Segment Creation
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires NSX-T segment creation, which translates to
      NetworkAttachmentDefinition in Kubernetes. However, your profile does not
      have network_security configured.

      TO FIX THIS:
      Add network_security configuration to your profile.yml:

        network_security:
          model: networkpolicy          # or: calico, cilium, istio, hybrid
          default_isolation: namespace  # or: pod, none

      Supported network security models:
        - networkpolicy: Standard Kubernetes NetworkPolicy
        - calico: Calico NetworkPolicy (requires Calico CNI)
        - cilium: Cilium NetworkPolicy (requires Cilium CNI)
        - istio: Istio AuthorizationPolicy (requires Istio service mesh)
        - hybrid: Use multiple policy types

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
