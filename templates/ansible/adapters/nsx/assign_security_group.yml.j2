---
# NSX Security Group to Pod Labels adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.network_security and profile.network_security.model != 'blocked' %}
- name: "Assign security group {{ '{{' }} security_group_name {{ '}}' }} to VM {{ '{{' }} vm_name {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    kind: VirtualMachine
    name: "{{ '{{' }} vm_name {{ '}}' }}"
    namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
    definition:
      metadata:
        labels:
          security-group: "{{ '{{' }} security_group_name | lower | replace('_', '-') {{ '}}' }}"
          {% if security_group_tags is defined %}
          {% for tag in security_group_tags %}
          {{ tag.key }}: "{{ tag.value }}"
          {% endfor %}
          {% endif %}
  register: security_group_result

- name: Display security group assignment result
  ansible.builtin.debug:
    msg: |
      NSX security group '{{ '{{' }} security_group_name {{ '}}' }}' translated to Kubernetes label.
      VM {{ '{{' }} vm_name {{ '}}' }} now has label: security-group={{ '{{' }} security_group_name | lower | replace('_', '-') {{ '}}' }}

      This label can be used in NetworkPolicy podSelectors to enforce firewall rules.

- name: "NOTICE: NetworkPolicy usage for security group {{ '{{' }} security_group_name {{ '}}' }}"
  ansible.builtin.debug:
    msg: |
      Security groups in NSX-T are translated to Kubernetes pod labels.
      To create firewall rules that reference this security group, use:

        podSelector:
          matchLabels:
            security-group: "{{ '{{' }} security_group_name | lower | replace('_', '-') {{ '}}' }}"

      in your NetworkPolicy definitions.

{% else %}
- name: "BLOCKED: NSX security group assignment - network_security profile not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: NSX Security Group Assignment
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow assigns NSX-T security groups to VMs, which translates to
      pod labels in Kubernetes. However, your profile does not have network_security
      configured.

      TO FIX THIS:
      Add network_security configuration to your profile.yml:

        network_security:
          model: networkpolicy          # or: calico, cilium, istio
          default_isolation: namespace  # or: pod, none

      How security groups translate to Kubernetes:
        - NSX Security Group → Kubernetes pod label (security-group: <name>)
        - Firewall rules → NetworkPolicy with podSelector matching the label
        - Dynamic membership → Labels applied to VirtualMachine resources

      Supported models:
        - networkpolicy: Standard Kubernetes NetworkPolicy
        - calico: Calico NetworkPolicy with advanced features
        - cilium: Cilium NetworkPolicy with eBPF enforcement
        - istio: Istio AuthorizationPolicy (L7 aware)

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
