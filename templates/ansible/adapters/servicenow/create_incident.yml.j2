---
# ServiceNow Incident/Ticket adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.itsm and profile.itsm.provider == 'servicenow' and profile.itsm.endpoint %}
- name: "Create ServiceNow incident: {{ '{{' }} incident_description {{ '}}' }}"
  uri:
    url: "{{ profile.itsm.endpoint }}/api/now/table/incident"
    method: POST
    user: "{{ '{{' }} {{ profile.itsm.username_var }} {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.itsm.password_var }} {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      short_description: "{{ '{{' }} incident_description {{ '}}' }}"
      description: "{{ '{{' }} incident_details | default('Automated incident from ops-translate workflow') {{ '}}' }}"
      urgency: "{{ '{{' }} urgency | default('3') {{ '}}' }}"
      impact: "{{ '{{' }} impact | default('3') {{ '}}' }}"
      priority: "{{ '{{' }} priority | default('3') {{ '}}' }}"
      assignment_group: "{{ '{{' }} assignment_group | default('Cloud Operations') {{ '}}' }}"
      category: "{{ '{{' }} category | default('Infrastructure') {{ '}}' }}"
      caller_id: "{{ '{{' }} caller_id | default('automation@ops-translate') {{ '}}' }}"
    status_code: 201
    return_content: yes
  register: incident_result

- name: Extract incident number
  ansible.builtin.set_fact:
    incident_number: "{{ '{{' }} incident_result.json.result.number {{ '}}' }}"
    incident_sys_id: "{{ '{{' }} incident_result.json.result.sys_id {{ '}}' }}"

- name: Display incident details
  ansible.builtin.debug:
    msg: "ServiceNow incident created: {{ '{{' }} incident_number {{ '}}' }} (sys_id: {{ '{{' }} incident_sys_id {{ '}}' }})"
{% elif profile.itsm and profile.itsm.provider == 'jira' and profile.itsm.endpoint %}
- name: "Create Jira issue: {{ '{{' }} incident_description {{ '}}' }}"
  uri:
    url: "{{ profile.itsm.endpoint }}/rest/api/2/issue"
    method: POST
    user: "{{ '{{' }} {{ profile.itsm.username_var }} {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.itsm.password_var }} {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      fields:
        project:
          key: "{{ '{{' }} jira_project_key | default('OPS') {{ '}}' }}"
        summary: "{{ '{{' }} incident_description {{ '}}' }}"
        description: "{{ '{{' }} incident_details | default('Automated issue from ops-translate workflow') {{ '}}' }}"
        issuetype:
          name: "{{ '{{' }} issue_type | default('Task') {{ '}}' }}"
        priority:
          name: "{{ '{{' }} priority | default('Medium') {{ '}}' }}"
    status_code: 201
    return_content: yes
  register: jira_result

- name: Extract Jira issue key
  ansible.builtin.set_fact:
    incident_number: "{{ '{{' }} jira_result.json.key {{ '}}' }}"

- name: Display Jira issue details
  ansible.builtin.debug:
    msg: "Jira issue created: {{ '{{' }} incident_number {{ '}}' }}"
{% elif profile.itsm and profile.itsm.provider == 'manual' %}
- name: "MANUAL: Create incident/ticket for {{ '{{' }} incident_description {{ '}}' }}"
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      MANUAL TICKETING REQUIRED
      ═══════════════════════════════════════════════════════════════════════════════

      Please create a ticket manually in your ITSM system with the following details:

      Description: {{ '{{' }} incident_description {{ '}}' }}
      Details: {{ '{{' }} incident_details | default('Automated workflow execution') {{ '}}' }}
      Urgency: {{ '{{' }} urgency | default('Medium') {{ '}}' }}
      Assignment Group: {{ '{{' }} assignment_group | default('Cloud Operations') {{ '}}' }}

      Once ticket is created, update your playbook variables with the ticket number.
      ═══════════════════════════════════════════════════════════════════════════════

- name: Set manual incident number
  ansible.builtin.set_fact:
    incident_number: "{{ '{{' }} manual_incident_number | default('MANUAL-TICKET-REQUIRED') {{ '}}' }}"
{% else %}
- name: "BLOCKED: ITSM ticketing required but not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: ITSM Ticketing Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires creation of an incident/ticket in your ITSM system,
      but your profile does not have ITSM integration configured.

      TO FIX THIS:
      Add ITSM configuration to your profile.yml:

        itsm:
          provider: servicenow              # or: jira, manual
          endpoint: https://your-instance.service-now.com
          username_var: itsm_username       # Ansible variable name
          password_var: itsm_password       # Ansible variable name

      Supported ITSM providers:
        - servicenow: ServiceNow ITSM (incident table)
        - jira: Atlassian Jira (issue creation)
        - manual: Manual ticketing (generates placeholder with instructions)

      For ServiceNow:
        - Uses REST API to create incident records
        - Returns incident number and sys_id
        - Supports urgency, impact, priority, assignment group

      For Jira:
        - Uses REST API v2 to create issues
        - Returns Jira issue key
        - Supports project, issue type, priority

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
