---
# ServiceNow Approval Request adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.approval and profile.approval.model == 'servicenow_approval' and profile.approval.endpoint %}
- name: "Request approval from {{ '{{' }} approver_group | default('Change Advisory Board') {{ '}}' }}"
  uri:
    url: "{{ profile.approval.endpoint }}/api/now/table/sysapproval_approver"
    method: POST
    user: "{{ '{{' }} {{ profile.approval.username_var }} {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.approval.password_var }} {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      source_table: "{{ '{{' }} source_table | default('change_request') {{ '}}' }}"
      sysapproval: "{{ '{{' }} approval_request_sys_id {{ '}}' }}"
      approver: "{{ '{{' }} approver_sys_id | default('') {{ '}}' }}"
      approver_group: "{{ '{{' }} approver_group | default('Change Advisory Board') {{ '}}' }}"
      comments: "{{ '{{' }} approval_comments | default('Approval requested for automated deployment') {{ '}}' }}"
      due_date: "{{ '{{' }} approval_due_date | default('') {{ '}}' }}"
    status_code: 201
    return_content: yes
  register: approval_request_result

- name: Extract approval request details
  ansible.builtin.set_fact:
    approval_request_sys_id: "{{ '{{' }} approval_request_result.json.result.sys_id {{ '}}' }}"
    approval_request_number: "{{ '{{' }} approval_request_result.json.result.number {{ '}}' }}"

- name: Display approval request details
  ansible.builtin.debug:
    msg: "ServiceNow approval requested: {{ '{{' }} approval_request_number {{ '}}' }} (sys_id: {{ '{{' }} approval_request_sys_id {{ '}}' }})"

- name: "Wait for approval: {{ '{{' }} approval_request_number {{ '}}' }}"
  uri:
    url: "{{ profile.approval.endpoint }}/api/now/table/sysapproval_approver/{{ '{{' }} approval_request_sys_id {{ '}}' }}"
    method: GET
    user: "{{ '{{' }} {{ profile.approval.username_var }} {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.approval.password_var }} {{ '}}' }}"
    force_basic_auth: yes
    status_code: 200
  register: approval_status
  until: approval_status.json.result.state in ['approved', 'rejected']
  retries: "{{ '{{' }} approval_timeout_minutes | default(120) {{ '}}' }}"
  delay: 60

- name: Verify approval was granted
  ansible.builtin.assert:
    that:
      - approval_status.json.result.state == 'approved'
    fail_msg: "Approval request {{ '{{' }} approval_request_number {{ '}}' }} was rejected"
    success_msg: "Approval request {{ '{{' }} approval_request_number {{ '}}' }} approved, proceeding"

{% elif profile.approval and profile.approval.model == 'manual_pause' %}
- name: "MANUAL APPROVAL REQUIRED: Pausing for manual approval"
  ansible.builtin.pause:
    prompt: |
      ═══════════════════════════════════════════════════════════════════════════════
      MANUAL APPROVAL REQUIRED
      ═══════════════════════════════════════════════════════════════════════════════

      Approval Request: {{ '{{' }} approval_comments | default('Automated deployment approval') {{ '}}' }}

      Press ENTER to approve and continue, or Ctrl+C then 'a' to abort.
      ═══════════════════════════════════════════════════════════════════════════════

{% else %}
- name: "BLOCKED: Approval required but no approval mechanism configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: Approval Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires approval before proceeding, but your profile does not
      have an approval mechanism configured.

      TO FIX THIS:
      Add approval configuration to your profile.yml:

        approval:
          model: servicenow_approval       # or: manual_pause
          endpoint: https://your-instance.service-now.com
          username_var: snow_username      # Ansible variable name
          password_var: snow_password      # Ansible variable name

      Supported approval models:
        - servicenow_approval: Request approval via ServiceNow approval record
        - manual_pause: Pause playbook for manual approval (interactive)

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
