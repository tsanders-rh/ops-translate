---
# ServiceNow Change Request adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.approval and profile.approval.model == 'servicenow_change' and profile.approval.endpoint %}
- name: "Create ServiceNow change request for {{ '{{' }} change_description {{ '}}' }}"
  uri:
    url: "{{ profile.approval.endpoint }}/api/now/table/change_request"
    method: POST
    user: "{{ '{{' }} {{ profile.approval.username_var }} {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.approval.password_var }} {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      short_description: "{{ '{{' }} change_description {{ '}}' }}"
      description: "{{ '{{' }} change_details | default('Automated change request from ops-translate') {{ '}}' }}"
      type: "{{ '{{' }} change_type | default('Normal') {{ '}}' }}"
      priority: "{{ '{{' }} change_priority | default('3') {{ '}}' }}"
      assignment_group: "{{ '{{' }} assignment_group | default('Cloud Operations') {{ '}}' }}"
      category: "{{ '{{' }} category | default('Cloud Infrastructure') {{ '}}' }}"
      implementation_plan: "{{ '{{' }} implementation_plan | default('Automated deployment via Ansible') {{ '}}' }}"
      risk_impact_analysis: "{{ '{{' }} risk_analysis | default('Low risk - automated process') {{ '}}' }}"
    status_code: 201
    return_content: yes
  register: change_request_result

- name: Extract change request number
  ansible.builtin.set_fact:
    change_request_number: "{{ '{{' }} change_request_result.json.result.number {{ '}}' }}"
    change_request_sys_id: "{{ '{{' }} change_request_result.json.result.sys_id {{ '}}' }}"

- name: Display change request details
  ansible.builtin.debug:
    msg: "ServiceNow change request created: {{ '{{' }} change_request_number {{ '}}' }} (sys_id: {{ '{{' }} change_request_sys_id {{ '}}' }})"

- name: "Wait for change request approval: {{ '{{' }} change_request_number {{ '}}' }}"
  uri:
    url: "{{ profile.approval.endpoint }}/api/now/table/change_request/{{ '{{' }} change_request_sys_id {{ '}}' }}"
    method: GET
    user: "{{ '{{' }} {{ profile.approval.username_var }} {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.approval.password_var }} {{ '}}' }}"
    force_basic_auth: yes
    status_code: 200
  register: change_status
  until: change_status.json.result.state in ['3', 'authorized']  # 3 = Authorized
  retries: "{{ '{{' }} approval_timeout_minutes | default(60) {{ '}}' }}"
  delay: 60

- name: Verify change request approval
  ansible.builtin.assert:
    that:
      - change_status.json.result.state == '3'
    fail_msg: "Change request {{ '{{' }} change_request_number {{ '}}' }} was not approved"
    success_msg: "Change request {{ '{{' }} change_request_number {{ '}}' }} approved, proceeding with deployment"
{% elif profile.approval and profile.approval.model == 'aap_workflow' %}
- name: "NOTICE: AAP workflow approval configured but not yet implemented"
  ansible.builtin.debug:
    msg: |
      Ansible Automation Platform workflow approval is configured but requires
      integration with AAP workflow job templates. Please create a workflow
      approval step manually in AAP for this deployment.
{% elif profile.approval and profile.approval.model == 'gitops_pr' %}
- name: "NOTICE: GitOps PR approval configured but not yet implemented"
  ansible.builtin.debug:
    msg: |
      GitOps pull request approval is configured. This deployment should be
      triggered via a pull request approval process in your Git repository.
{% elif profile.approval and profile.approval.model == 'manual_pause' %}
- name: "MANUAL APPROVAL REQUIRED: Pausing for manual approval"
  ansible.builtin.pause:
    prompt: |
      ═══════════════════════════════════════════════════════════════════════════════
      MANUAL APPROVAL REQUIRED
      ═══════════════════════════════════════════════════════════════════════════════

      Change Description: {{ '{{' }} change_description {{ '}}' }}

      Press ENTER to approve and continue, or Ctrl+C then 'a' to abort.
      ═══════════════════════════════════════════════════════════════════════════════
{% else %}
- name: "BLOCKED: Approval required but no approval mechanism configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: Approval Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires approval before proceeding, but your profile does not
      have an approval mechanism configured.

      TO FIX THIS:
      Add approval configuration to your profile.yml:

        approval:
          model: servicenow_change        # or: aap_workflow, gitops_pr, manual_pause
          endpoint: https://your-instance.service-now.com
          username_var: snow_username     # Ansible variable name
          password_var: snow_password     # Ansible variable name

      Supported approval models:
        - servicenow_change: Create ServiceNow change request and wait for approval
        - aap_workflow: Use Ansible Automation Platform workflow approval
        - gitops_pr: Require pull request approval in Git repository
        - manual_pause: Pause playbook for manual approval (interactive)

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
