---
# DNS Record Creation adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.dns and profile.dns.provider == 'infoblox' and profile.dns.endpoint %}
- name: "Create DNS A record in Infoblox: {{ '{{' }} dns_hostname {{ '}}' }} -> {{ '{{' }} dns_ip_address {{ '}}' }}"
  uri:
    url: "{{ profile.dns.endpoint }}/wapi/v2.11/record:a"
    method: POST
    user: "{{ '{{' }} {{ profile.dns.credentials_var }}_username {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.dns.credentials_var }}_password {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "{{ '{{' }} dns_hostname {{ '}}' }}"
      ipv4addr: "{{ '{{' }} dns_ip_address {{ '}}' }}"
      view: "{{ '{{' }} dns_view | default('default') {{ '}}' }}"
      comment: "Created by ops-translate"
    status_code: 201
    return_content: yes
  register: dns_result

- name: Display DNS record creation result
  ansible.builtin.debug:
    msg: "Infoblox DNS A record created: {{ '{{' }} dns_hostname {{ '}}' }} -> {{ '{{' }} dns_ip_address {{ '}}' }}"
{% elif profile.dns and profile.dns.provider == 'externaldns' %}
- name: "Create Service for ExternalDNS to manage {{ '{{' }} dns_hostname {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ '{{' }} dns_hostname.split('.')[0] {{ '}}' }}"
        namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "{{ '{{' }} dns_hostname {{ '}}' }}"
          external-dns.alpha.kubernetes.io/ttl: "{{ '{{' }} dns_ttl | default('300') {{ '}}' }}"
      spec:
        type: LoadBalancer
        loadBalancerIP: "{{ '{{' }} dns_ip_address {{ '}}' }}"
        ports:
          - port: 80
            targetPort: 80
        selector:
          app: "{{ '{{' }} dns_hostname.split('.')[0] {{ '}}' }}"
  register: externaldns_result

- name: Display ExternalDNS service creation result
  ansible.builtin.debug:
    msg: "ExternalDNS will create DNS record for {{ '{{' }} dns_hostname {{ '}}' }} via Service annotation"
{% elif profile.dns and profile.dns.provider == 'coredns' %}
- name: "Add DNS record to CoreDNS configmap for {{ '{{' }} dns_hostname {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: coredns-custom
        namespace: kube-system
      data:
        custom.server: |
          {{ '{{' }} dns_hostname {{ '}}' }} {
              hosts {
                  {{ '{{' }} dns_ip_address {{ '}}' }} {{ '{{' }} dns_hostname {{ '}}' }}
                  fallthrough
              }
          }
  register: coredns_result

- name: Display CoreDNS configuration result
  ansible.builtin.debug:
    msg: "CoreDNS custom configuration updated for {{ '{{' }} dns_hostname {{ '}}' }}"
{% elif profile.dns and profile.dns.provider == 'manual' %}
- name: "MANUAL: Create DNS record for {{ '{{' }} dns_hostname {{ '}}' }}"
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      MANUAL DNS RECORD CREATION REQUIRED
      ═══════════════════════════════════════════════════════════════════════════════

      Please create the following DNS A record manually in your DNS system:

      Hostname: {{ '{{' }} dns_hostname {{ '}}' }}
      IP Address: {{ '{{' }} dns_ip_address {{ '}}' }}
      TTL: {{ '{{' }} dns_ttl | default('300') {{ '}}' }}

      Once the DNS record is created, verify resolution before proceeding.
      ═══════════════════════════════════════════════════════════════════════════════
{% else %}
- name: "BLOCKED: DNS record creation required but not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: DNS Record Creation Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires DNS record creation, but your profile does not have
      DNS integration configured.

      TO FIX THIS:
      Add DNS configuration to your profile.yml:

        dns:
          provider: infoblox                  # or: externaldns, coredns, manual
          endpoint: https://infoblox.acme.com
          credentials_var: infoblox_creds     # Ansible variable name

      Supported DNS providers:
        - infoblox: Infoblox DDI platform (WAPI v2.11)
          Requires: endpoint, credentials_var (username/password)
          Creates DNS A records via REST API

        - externaldns: Kubernetes ExternalDNS controller
          No endpoint required - uses Service annotations
          Automatically creates DNS records for LoadBalancer services

        - coredns: CoreDNS with custom configuration
          No endpoint required - updates CoreDNS configmap
          Suitable for internal cluster DNS records

        - manual: Manual DNS management
          Generates instructions for manual record creation
          Use when automated DNS is not available

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
