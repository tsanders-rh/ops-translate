---
# DNS Reverse Zone (PTR) Record Creation adapter
# Generated by ops-translate from profile: {{ profile.name }}

{% if profile.dns and profile.dns.provider == 'infoblox' and profile.dns.endpoint %}
- name: "Create DNS PTR record in Infoblox: {{ '{{' }} dns_ip_address {{ '}}' }} -> {{ '{{' }} dns_hostname {{ '}}' }}"
  uri:
    url: "{{ profile.dns.endpoint }}/wapi/v2.11/record:ptr"
    method: POST
    user: "{{ '{{' }} {{ profile.dns.credentials_var }}_username {{ '}}' }}"
    password: "{{ '{{' }} {{ profile.dns.credentials_var }}_password {{ '}}' }}"
    force_basic_auth: yes
    body_format: json
    body:
      ptrdname: "{{ '{{' }} dns_hostname {{ '}}' }}"
      ipv4addr: "{{ '{{' }} dns_ip_address {{ '}}' }}"
      view: "{{ '{{' }} dns_view | default('default') {{ '}}' }}"
      comment: "Created by ops-translate"
    status_code: 201
    return_content: yes
  register: ptr_result

- name: Display PTR record creation result
  ansible.builtin.debug:
    msg: "Infoblox PTR record created: {{ '{{' }} dns_ip_address {{ '}}' }} -> {{ '{{' }} dns_hostname {{ '}}' }}"
{% elif profile.dns and profile.dns.provider == 'externaldns' %}
- name: "NOTICE: ExternalDNS PTR record management"
  ansible.builtin.debug:
    msg: |
      ExternalDNS does not automatically create PTR records.

      If PTR records are required, either:
      1. Configure your DNS provider to auto-create PTR for A records
      2. Use a separate automation to create reverse zone records
      3. Switch to manual PTR record creation

      Forward DNS (A record) will be created via Service annotation.
{% elif profile.dns and profile.dns.provider == 'coredns' %}
- name: "Add PTR record to CoreDNS configmap for {{ '{{' }} dns_ip_address {{ '}}' }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: coredns-custom-ptr
        namespace: kube-system
      data:
        ptr.server: |
          {{ '{{' }} dns_ip_address.split('.')[::-1] | join('.') {{ '}}' }}.in-addr.arpa {
              hosts {
                  {{ '{{' }} dns_ip_address {{ '}}' }} {{ '{{' }} dns_hostname {{ '}}' }}
                  fallthrough
              }
          }
  register: coredns_ptr_result

- name: Display CoreDNS PTR configuration result
  ansible.builtin.debug:
    msg: "CoreDNS PTR record configured for {{ '{{' }} dns_ip_address {{ '}}' }}"
{% elif profile.dns and profile.dns.provider == 'manual' %}
- name: "MANUAL: Create DNS PTR record for {{ '{{' }} dns_ip_address {{ '}}' }}"
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      MANUAL DNS PTR RECORD CREATION REQUIRED
      ═══════════════════════════════════════════════════════════════════════════════

      Please create the following DNS PTR record manually in your DNS system:

      IP Address: {{ '{{' }} dns_ip_address {{ '}}' }}
      PTR Record: {{ '{{' }} dns_hostname {{ '}}' }}
      Reverse Zone: {{ '{{' }} dns_ip_address.split('.')[2] {{ '}}' }}.{{ '{{' }} dns_ip_address.split('.')[1] {{ '}}' }}.{{ '{{' }} dns_ip_address.split('.')[0] {{ '}}' }}.in-addr.arpa
      TTL: {{ '{{' }} dns_ttl | default('300') {{ '}}' }}

      Once the PTR record is created, verify reverse resolution before proceeding.
      ═══════════════════════════════════════════════════════════════════════════════
{% else %}
- name: "BLOCKED: DNS PTR record creation required but not configured"
  ansible.builtin.fail:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════════
      BLOCKED: DNS PTR Record Creation Required
      ═══════════════════════════════════════════════════════════════════════════════

      This workflow requires DNS reverse zone (PTR) record creation, but your
      profile does not have DNS integration configured.

      TO FIX THIS:
      Add DNS configuration to your profile.yml:

        dns:
          provider: infoblox                  # or: coredns, manual
          endpoint: https://infoblox.acme.com
          credentials_var: infoblox_creds     # Ansible variable name

      Supported DNS providers for PTR records:
        - infoblox: Infoblox DDI platform (WAPI v2.11)
          Requires: endpoint, credentials_var (username/password)
          Creates PTR records via REST API

        - coredns: CoreDNS with custom configuration
          No endpoint required - updates CoreDNS configmap
          Suitable for internal cluster reverse DNS

        - manual: Manual DNS management
          Generates instructions for manual PTR record creation

      NOTE: ExternalDNS does not support automated PTR record creation.
      If using ExternalDNS, switch to manual or infoblox for PTR records.

      Once configured, re-run the generator to produce functional adapter stubs.
      ═══════════════════════════════════════════════════════════════════════════════
{% endif %}
