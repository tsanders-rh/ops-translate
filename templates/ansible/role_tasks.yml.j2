---
# Ansible role tasks for {{ intent.workflow_name }}
# Generated by ops-translate

- name: Set facts from inputs
  ansible.builtin.set_fact:
{% for input_name, input_spec in intent.inputs.items() %}
    {{ input_name }}: "{{ '{{' }} {{ input_name }} {{ '}}' }}"
{% endfor %}

{% if intent.profiles %}
- name: Determine environment-specific configuration
  ansible.builtin.set_fact:
{% for profile_key, profile_value in intent.profiles.items() %}
{% if profile_value is mapping and 'when' in profile_value %}
    {{ profile_key }}: "{{ '{{' }} '{{ profile_value.value }}' if ({{ profile_value.when | tojson | replace('{', '') | replace('}', '') }}) else '{{ profile_value.get('else', 'default') }}' {{ '}}' }}"
{% else %}
    {{ profile_key }}: "{{ profile_value }}"
{% endif %}
{% endfor %}
{% endif %}

- name: Create VM resource
  community.kubevirt.kubevirt_vm:
    state: present
    namespace: "{{ '{{' }} target_namespace {{ '}}' }}"
    definition:
      apiVersion: kubevirt.io/v1
      kind: VirtualMachine
      metadata:
        name: "{{ '{{' }} vm_name {{ '}}' }}"
{% if intent.metadata and intent.metadata.tags %}
        labels:
{% for tag in intent.metadata.tags %}
          {{ tag.key }}: "{{ '{{' }} {{ tag.value_from }} {{ '}}' }}"
{% endfor %}
{% endif %}
      spec:
        running: true
        template:
          spec:
            domain:
              devices:
                disks:
                  - name: containerdisk
                    disk:
                      bus: virtio
              resources:
                requests:
{% if intent.compute %}
                  memory: "{{ intent.compute.memory_gb | default(2) }}Gi"
                  cpu: "{{ intent.compute.cpu_count | default(1) }}"
{% else %}
                  memory: "2Gi"
                  cpu: "1"
{% endif %}
            volumes:
              - name: containerdisk
                containerDisk:
                  image: quay.io/kubevirt/cirros-container-disk-demo
  register: vm_creation

- name: Display VM creation result
  ansible.builtin.debug:
    var: vm_creation
