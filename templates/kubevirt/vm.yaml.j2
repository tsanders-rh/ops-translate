---
# KubeVirt VirtualMachine manifest
# Generated by ops-translate from workflow: {{ intent.workflow_name }}
# Target profile: {{ profile_name }}

apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: {{ intent.workflow_name | replace('_', '-') }}
  namespace: {{ profile.default_namespace | default('default') }}
  labels:
    app: {{ intent.workflow_name }}
    workload-type: {{ intent.workload_type | default('virtual-machine') }}
{% if intent.metadata and intent.metadata.tags %}
{% for tag in intent.metadata.tags %}
    {{ tag.key }}: "{{ tag.value_from | replace('_', '-') }}"
{% endfor %}
{% endif %}
    managed-by: ops-translate
  annotations:
    ops-translate/source-type: "{{ intent.sources[0].type if intent.sources else 'unknown' }}"
    ops-translate/generated: "{{ timestamp }}"
{% if intent.governance and intent.governance.approval %}
    ops-translate/approval-required: "true"
{% endif %}

spec:
  running: true

  template:
    metadata:
      labels:
        kubevirt.io/domain: {{ intent.workflow_name }}
{% if intent.metadata and intent.metadata.tags %}
{% for tag in intent.metadata.tags %}
        {{ tag.key }}: "{{ tag.value_from | replace('_', '-') }}"
{% endfor %}
{% endif %}

    spec:
      domain:
        cpu:
{% if intent.inputs and 'cpu' in intent.inputs %}
          cores: {{ intent.inputs.cpu.get('default', 2) }}
{% else %}
          cores: 2
{% endif %}

        devices:
          disks:
            - name: rootdisk
              disk:
                bus: virtio
            - name: cloudinitdisk
              disk:
                bus: virtio

          interfaces:
            - name: default
              masquerade: {}

        resources:
          requests:
{% if intent.inputs and 'memory_gb' in intent.inputs %}
            memory: {{ intent.inputs.memory_gb.get('default', 2) }}Gi
{% else %}
            memory: 2Gi
{% endif %}
{% if intent.inputs and 'cpu' in intent.inputs %}
            cpu: {{ intent.inputs.cpu.get('default', 2) }}
{% else %}
            cpu: 2
{% endif %}

      networks:
        - name: default
          pod: {}

      volumes:
        - name: rootdisk
          containerDisk:
            image: quay.io/kubevirt/cirros-container-disk-demo

        - name: cloudinitdisk
          cloudInitNoCloud:
            userDataBase64: {{ cloud_init_data | default('') }}
