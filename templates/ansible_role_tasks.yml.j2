---
# Tasks for provision_vm role
# Generated by ops-translate

- name: Validate required inputs
  ansible.builtin.assert:
    that:
{%- for param_name, param_spec in intent.inputs.items() %}
{%- if param_spec.required %}
      - {{ param_name }} is defined
      - {{ param_name }} | length > 0
{%- endif %}
{%- if param_spec.type == 'integer' and (param_spec.min is defined or param_spec.max is defined) %}
{%- if param_spec.min is defined %}
      - {{ param_name }} >= {{ param_spec.min }}
{%- endif %}
{%- if param_spec.max is defined %}
      - {{ param_name }} <= {{ param_spec.max }}
{%- endif %}
{%- endif %}
{%- if param_spec.type == 'enum' %}
      - {{ param_name }} in {{ param_spec.values }}
{%- endif %}
{%- endfor %}
    fail_msg: "Input validation failed. Please check required parameters."
    success_msg: "All required inputs validated successfully"

{%- if intent.governance and intent.governance.approval and intent.governance.approval.required_when %}

- name: Check for approval requirements
  ansible.builtin.debug:
    msg: |
      WARNING: This deployment may require approval.
      Conditions: {{ intent.governance.approval.required_when }}
{%- for condition_var, condition_value in intent.governance.approval.required_when.items() %}
  when: {{ condition_var }} == "{{ condition_value }}"
{%- endfor %}
{%- endif %}

- name: Set resource profiles based on environment
  ansible.builtin.set_fact:
{%- if intent.profiles %}
{%- for profile_key, profile_spec in intent.profiles.items() %}
{%- if not profile_key.endswith('_else') and profile_spec is mapping and 'when' in profile_spec %}
    {{ profile_key }}_selected: >-
      {{ '{{' }} '{{ profile_spec.value }}' if ({{ list(profile_spec.when.keys())[0] }} == '{{ list(profile_spec.when.values())[0] }}') else '{{ intent.profiles.get(profile_key + '_else', 'default') }}' {{ '}}' }}
{%- endif %}
{%- endfor %}
{%- endif %}

- name: Display provisioning summary
  ansible.builtin.debug:
    msg:
      - "========== VM Provisioning Summary =========="
      - "VM Name: {{ '{{ vm_name }}' }}"
{%- for param_name in intent.inputs.keys() %}
{%- if param_name != 'vm_name' %}
      - "{{ param_name | replace('_', ' ') | title }}: {{ '{{ ' }}{{ param_name }}{{ ' }}' }}"
{%- endif %}
{%- endfor %}
      - "Namespace: {{ profile.default_namespace }}"
      - "=============================================="

- name: Create KubeVirt VirtualMachine
  kubernetes.core.k8s:
    state: present
    definition: "{{ '{{ lookup' }}('file', 'vm.yaml') {{ '}}' }}"
    namespace: {{ profile.default_namespace }}
  register: vm_result

- name: Display provisioning result
  ansible.builtin.debug:
    msg: "VM {{ '{{ vm_name }}' }} provisioned successfully"
  when: vm_result is success
